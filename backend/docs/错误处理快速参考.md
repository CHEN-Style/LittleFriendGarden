# é”™è¯¯å¤„ç†å’Œæ—¥å¿—ç³»ç»Ÿ - å¿«é€Ÿå‚è€ƒ

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å¯¼å…¥å¿…è¦çš„æ¨¡å—

```javascript
import { asyncHandler } from './src/middleware/index.js';
import {
  ValidationError,
  AuthError,
  ForbiddenError,
  NotFoundError,
  ConflictError,
  DatabaseError,
} from './src/errors/index.js';
```

### 2. åœ¨è·¯ç”±ä¸­ä½¿ç”¨

```javascript
// ä½¿ç”¨ asyncHandler åŒ…è£…å¼‚æ­¥è·¯ç”±
app.get('/users/:id', asyncHandler(async (req, res) => {
  const user = await prisma.user.findUnique({
    where: { id: parseInt(req.params.id) },
  });
  
  if (!user) {
    throw new NotFoundError('User not found', { userId: req.params.id });
  }
  
  res.json(user);
}));
```

---

## ğŸ“‹ é”™è¯¯ç±»é€ŸæŸ¥è¡¨

| é”™è¯¯ç±» | HTTP | ä½¿ç”¨åœºæ™¯ |
|--------|------|----------|
| `ValidationError` | 400 | æ•°æ®éªŒè¯å¤±è´¥ |
| `AuthError` | 401 | è®¤è¯å¤±è´¥ï¼ˆæœªç™»å½•ï¼‰ |
| `ForbiddenError` | 403 | æˆæƒå¤±è´¥ï¼ˆæƒé™ä¸è¶³ï¼‰ |
| `NotFoundError` | 404 | èµ„æºæœªæ‰¾åˆ° |
| `ConflictError` | 409 | èµ„æºå†²çªï¼ˆå¦‚é‡å¤ï¼‰ |
| `DatabaseError` | 500 | æ•°æ®åº“é”™è¯¯ |

---

## ğŸ’¡ å¸¸è§ç”¨æ³•ç¤ºä¾‹

### éªŒè¯é”™è¯¯

```javascript
if (!email || !email.includes('@')) {
  throw new ValidationError('Invalid email format', {
    field: 'email',
    value: email,
  });
}
```

### èµ„æºæœªæ‰¾åˆ°

```javascript
const user = await prisma.user.findUnique({ where: { id } });
if (!user) {
  throw new NotFoundError('User not found', { userId: id });
}
```

### èµ„æºå†²çª

```javascript
const existing = await prisma.user.findUnique({ where: { email } });
if (existing) {
  throw new ConflictError('Email already exists', { email });
}
```

### è®¤è¯é”™è¯¯

```javascript
if (!token) {
  throw new AuthError('Authentication required');
}
```

### æˆæƒé”™è¯¯

```javascript
if (user.id !== resource.ownerId) {
  throw new ForbiddenError('Access denied', {
    userId: user.id,
    resourceId: resource.id,
  });
}
```

---

## ğŸ“Š æ—¥å¿—ä½¿ç”¨

### åœ¨è·¯ç”±ä¸­è®°å½•æ—¥å¿—

```javascript
app.get('/users', asyncHandler(async (req, res) => {
  req.logger.info('Fetching users list');
  
  const users = await prisma.user.findMany();
  
  req.logger.info(`Found ${users.length} users`);
  
  res.json(users);
}));
```

### æ—¥å¿—çº§åˆ«

```javascript
req.logger.debug('Debug info');     // è°ƒè¯•ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰
req.logger.info('Normal info');     // ä¸€èˆ¬ä¿¡æ¯
req.logger.warn('Warning');         // è­¦å‘Š
req.logger.error('Error');          // é”™è¯¯
```

### å¸¦ä¸Šä¸‹æ–‡çš„æ—¥å¿—

```javascript
req.logger.info('User login', {
  userId: user.id,
  ip: req.ip,
  userAgent: req.get('user-agent'),
});
```

---

## ğŸ”§ ä¸­é—´ä»¶é…ç½®

### æ­£ç¡®çš„é¡ºåº

```javascript
// 1. åŸºç¡€ä¸­é—´ä»¶
app.use(express.json());
app.use(cors());

// 2. æ—¥å¿—å’Œè¿½è¸ª
app.use(requestIdMiddleware);
app.use(performanceLogger);
app.use(requestLogger);

// 3. ä¸šåŠ¡è·¯ç”±
app.use('/api/users', userRoutes);

// 4. é”™è¯¯å¤„ç†ï¼ˆå¿…é¡»æœ€åï¼‰
app.use(notFoundHandler);
app.use(errorHandler);
```

---

## ğŸ¯ æœ€ä½³å®è·µ

### âœ… æ¨è

```javascript
// ä½¿ç”¨ asyncHandler
app.get('/users', asyncHandler(async (req, res) => {
  const users = await prisma.user.findMany();
  res.json(users);
}));

// æä¾›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
throw new ValidationError('Invalid age', {
  field: 'age',
  value: -5,
  min: 0,
  max: 150,
});

// è®°å½•æœ‰æ„ä¹‰çš„æ—¥å¿—
req.logger.info('User created', {
  userId: user.id,
  email: user.email,
});
```

### âŒ é¿å…

```javascript
// ä¸ä½¿ç”¨ asyncHandlerï¼ˆé”™è¯¯ä¸ä¼šè¢«æ•è·ï¼‰
app.get('/users', async (req, res) => {
  const users = await prisma.user.findMany();
  res.json(users);
});

// ç¼ºå°‘é”™è¯¯ä¸Šä¸‹æ–‡
throw new ValidationError('Invalid age');

// è®°å½•æ•æ„Ÿä¿¡æ¯
req.logger.info('User login', {
  password: user.password,  // ä¸è¦è¿™æ ·åšï¼
});
```

---

## ğŸ” è°ƒè¯•æŠ€å·§

### æŸ¥çœ‹æ—¥å¿—

```bash
# æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—
cat logs/combined.log

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
cat logs/error.log

# å®æ—¶æŸ¥çœ‹æ—¥å¿—
tail -f logs/combined.log

# æœç´¢ç‰¹å®š Request ID çš„æ—¥å¿—
grep "abc-123-xyz" logs/combined.log
```

### è‡ªå®šä¹‰ Request ID

```bash
# å®¢æˆ·ç«¯æä¾› Request ID
curl -H "X-Request-ID: my-custom-id" http://localhost:3000/api/users
```

---

## ğŸ“– å®Œæ•´æ–‡æ¡£

è¯¦ç»†æ–‡æ¡£è¯·å‚è€ƒï¼š
- **[é”™è¯¯å¤„ç†å’Œæ—¥å¿—æŒ‡å—](é”™è¯¯å¤„ç†å’Œæ—¥å¿—æŒ‡å—.md)** - å®Œæ•´æŒ‡å—
- **[TEST-RESULTS.md](../TEST-RESULTS.md)** - æµ‹è¯•æŠ¥å‘Š

---

## ğŸ†˜ å¸¸è§é—®é¢˜

### Q: é”™è¯¯æ²¡æœ‰è¢«æ•è·ï¼Ÿ
A: ç¡®ä¿ä½¿ç”¨ `asyncHandler` åŒ…è£…å¼‚æ­¥è·¯ç”±ã€‚

### Q: æ—¥å¿—æ²¡æœ‰æ˜¾ç¤ºåœ¨æ§åˆ¶å°ï¼Ÿ
A: æ£€æŸ¥ `NODE_ENV` ç¯å¢ƒå˜é‡ï¼Œå¼€å‘ç¯å¢ƒéœ€è¦è®¾ç½®ä¸º `development`ã€‚

### Q: æ…¢è¯·æ±‚é˜ˆå€¼æ˜¯å¤šå°‘ï¼Ÿ
A: è¶…è¿‡ 500ms è®°å½• info æ—¥å¿—ï¼Œè¶…è¿‡ 1000ms è®°å½• warn æ—¥å¿—ã€‚

### Q: å¦‚ä½•è¿‡æ»¤æ•æ„Ÿå­—æ®µï¼Ÿ
A: ç³»ç»Ÿè‡ªåŠ¨è¿‡æ»¤ `password`, `token`, `secret`, `apiKey` ç­‰å­—æ®µã€‚

### Q: Prisma é”™è¯¯å¦‚ä½•å¤„ç†ï¼Ÿ
A: ç³»ç»Ÿè‡ªåŠ¨è½¬æ¢å¸¸è§ Prisma é”™è¯¯ï¼ˆP2002â†’409, P2025â†’404ç­‰ï¼‰ã€‚

