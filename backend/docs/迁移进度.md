# 数据库迁移进度

## ✅ 已完成

### Phase 1 - Auth 域（账号与身份）

**迁移文件**：
- `20251030154948_init_auth_domain` - 初始化基础表
- `20251030160821_add_relations_notifications_todos` - 添加关系和功能表

**已完成的表**：

#### 1. 用户主表 (users)
- ✅ UUID 主键
- ✅ CITEXT 类型的 email 和 username（大小写不敏感）
- ✅ 软删除支持
- ✅ JSONB 设置字段
- ✅ 自动时间戳（created_at, updated_at）

#### 2. 用户档案 (user_profiles)
- ✅ 1:1 关系到用户
- ✅ 可见性控制（CHECK 约束）
- ✅ 软删除支持

#### 3. 第三方身份 (user_identities)
- ✅ 多对一关系到用户
- ✅ provider + providerUid 唯一约束
- ✅ JSONB 元数据

#### 4. 关注关系 (user_follows)
- ✅ 复合主键（follower_user_id, followee_user_id）
- ✅ CHECK 约束（不能关注自己）
- ✅ 双向索引（关注者和被关注者）

#### 5. 屏蔽关系 (user_blocks)
- ✅ 复合主键（blocker_user_id, blocked_user_id）
- ✅ CHECK 约束（不能屏蔽自己）
- ✅ 双向索引

#### 6. 通知中心 (notifications)
- ✅ 类型化通知（type 字段）
- ✅ JSONB payload 灵活内容
- ✅ 已读状态跟踪
- ✅ 复合索引（user_id, is_read, created_at）

#### 7. 用户待办 (user_todos)
- ✅ CHECK 约束（priority, status）
- ✅ 标签数组 + GIN 索引（快速搜索）
- ✅ 软删除支持
- ✅ 可选关联宠物（pet_id，外键将在 Pet 域完成后添加）
- ✅ updated_at 触发器自动更新

**数据库扩展**：
- ✅ pgcrypto（UUID 支持）
- ✅ citext（大小写不敏感文本）

**测试结果**：
- ✅ 所有表创建成功
- ✅ 所有约束正常工作
- ✅ 所有索引生效
- ✅ Prisma Client 关系查询正常
- ✅ CITEXT 大小写不敏感验证通过
- ✅ 标签 GIN 索引搜索正常

---

## 📅 待完成

### Phase 2 - Pet 域（宠物主数据与素材池）
- [ ] pets（宠物档案表）
- [ ] pet_members（宠物成员共享表）
- [ ] pet_media（素材池表）
- [ ] pet_events（通用事件时间轴）
- [ ] pet_weight_records（体重记录）
- [ ] pet_feeding_records（喂养记录）
- [ ] pet_vaccine_records（疫苗记录）
- [ ] pet_medication_records（用药记录）
- [ ] reminders（提醒表）

### Phase 3 - Social 域（人类社群）
- [ ] posts（发帖表）
- [ ] comments（评论表）
- [ ] likes（点赞表）
- [ ] bookmarks（收藏表）
- [ ] topics（话题表）
- [ ] post_topics（帖子话题关联表）

### Phase 4 - AI 圈层（P2，规划中）
- [ ] pet_accounts（宠物账号）
- [ ] ai_posts（AI 生成的帖子）
- [ ] ai_comments（AI 生成的评论）
- [ ] city_context（城市语境）
- [ ] events（城市事件）
- [ ] elections（选举）

---

## 📊 统计

- **已完成表**：7 个
- **待完成表**：20+ 个
- **完成度**：~25%（Phase 1 完成）

---

## 🔧 数据库信息

- **数据库名称**：db-LFG
- **Schema**：public
- **版本**：PostgreSQL 13+
- **字符编码**：UTF-8
- **时区**：使用 TIMESTAMPTZ

---

## 📝 注意事项

1. **pet_id 外键**：user_todos 表中的 pet_id 字段目前没有外键约束，需要在 Pet 域表创建后添加：
   ```sql
   ALTER TABLE user_todos
     ADD CONSTRAINT fk_user_todos_pet
     FOREIGN KEY (pet_id) REFERENCES pets(id) ON DELETE SET NULL;
   ```

2. **软删除**：所有支持软删除的表都有 deleted_at 字段，应用层需要添加 WHERE deleted_at IS NULL 过滤

3. **JSONB 字段**：
   - users.settings - 用户偏好设置
   - user_identities.meta - 第三方身份元数据
   - notifications.payload - 通知内容

4. **数组字段**：
   - user_todos.tags - 使用 GIN 索引支持快速搜索

5. **触发器**：
   - 所有带 updated_at 的表都有自动更新触发器

---

> **最后更新**：2025-10-30
> **下一步**：开始 Pet 域的 Schema 设计与迁移

