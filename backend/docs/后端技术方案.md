# 后端技术方案（P1 阶段）

> **项目**：小友花园（LittleFriendGarden）  
> **版本**：P1 - 宠物记录与人类社群  
> **更新**：2025-10-29

---

## 📋 技术选型

### 核心技术栈
- **运行时**：Node.js 18+ / JavaScript (ES6+)
- **Web 框架**：Express.js
- **ORM**：Prisma 5.x
- **数据库**：PostgreSQL 13+（扩展：`pgcrypto`、`citext`）
- **缓存**：Redis 7.x
- **认证**：JWT + Passport.js

### 支持工具
- **日志**：Winston / Pino
- **验证**：Joi / Zod
- **测试**：Jest + Supertest
- **文档**：OpenAPI 3.0

---

## 🏗️ 架构设计

### 分层架构
```
Controller  → HTTP 请求处理、参数校验
Service     → 业务逻辑、权限校验、事务协调
Repository  → 数据访问封装、复杂查询
Prisma      → ORM 数据库映射
PostgreSQL  → 数据存储（触发器、RLS、视图）
```

### 目录组织（按业务域）
```
backend/src/
├── domains/              # 业务域（垂直划分）
│   ├── auth/            # 账号与关系
│   ├── pet/             # 宠物主数据与记录
│   ├── social/          # 用户社群
│   └── calendar/        # 日历聚合（查询层）
├── shared/              # 共享基础设施
│   ├── database/        # Prisma Client
│   ├── middleware/      # 认证、日志、错误处理
│   ├── utils/           # 工具函数
│   └── events/          # 事件总线（P2 预留）
└── prisma/
    ├── schema.prisma
    └── migrations/
└── app.js                # 应用入口
```

---

## 💡 核心设计原则

### 1. 依赖注入 + 实例方法
- 使用构造函数注入依赖（避免全局变量）
- 使用 `this` 访问实例属性（避免静态方法）
- Controller → Service → Repository 逐层注入

### 2. 职责分离
- **Repository**：数据访问，无业务逻辑
- **Service**：业务逻辑，可调用多个 Repository
- **Controller**：HTTP 适配，参数校验

### 3. 数据库优先策略
- **触发器**：`updated_at` 自动更新、计数同步
- **CHECK 约束**：TEXT + CHECK 代替 ENUM（易扩展）
- **软删除**：统一 `deleted_at` + 部分索引
- **RLS**：行级安全（可选启用）

---

## 🗂️ 数据域划分

| 域 | 核心表 | 职责 |
|---|--------|------|
| **Auth** | users, user_profiles, user_follows, user_blocks, user_todos | 用户认证、关注/拉黑、待办 |
| **Pet** | pets, pet_owners, pet_assets, pet_weights, pet_feedings, reminders | 宠物档案、素材池、健康记录 |
| **Social** | posts, comments, topics, reactions, reports | 发帖、评论、点赞、举报 |
| **Calendar** | calendar_items_v（视图） | 聚合 todos + reminders |

---

## 🔧 关键技术约定

### Prisma 集成
- **不用** `@updatedAt`（数据库有触发器）
- **手动维护** CHECK 约束（编辑 migration.sql）
- **视图** 用 `@@ignore` 标记（不生成迁移）
- **软删除** 用中间件全局过滤 `deletedAt: null`

### Repository 封装
- **简单查询**：直接用 Prisma Client
- **复杂查询**：封装业务语义方法
- **多表聚合**：使用 `$queryRaw` 原生 SQL

### P2 扩展预留
- **事件总线**：Service 发布事件，AI 订阅
- **AI 查询方法**：Repository 预留素材召回接口

---

## 🔑 通用约定

- **时间**：统一 UTC（前端本地化）
- **ID**：UUID（`gen_random_uuid()`）
- **软删除**：`deleted_at` + 默认过滤
- **枚举**：TEXT + CHECK（避免 ENUM 迁移问题）
- **外键**：核心用 `CASCADE`，可选用 `SET NULL`

---

## 📝 开发进度

### ✅ 已完成（P1 - Auth 域）
- [x] 技术选型确定
- [x] 架构设计
- [x] 数据库 Schema 设计（Auth 域 - 7 张表）
- [x] Prisma Schema 编写（Auth 域）
- [x] 数据库迁移（2 次迁移成功应用）
- [x] 数据库扩展配置（citext、pgcrypto）
- [x] 触发器和约束实现
- [x] 项目文档体系建立

### 🔄 进行中
- [ ] 其他数据域设计（Pet、Social、Calendar）
- [ ] Repository 层实现
- [ ] Service 层实现
- [ ] Controller 层实现

### 📅 计划中（P1）
- [ ] 认证中间件（JWT + Passport）
- [ ] 错误处理与日志（Winston）
- [ ] 参数验证（Joi/Zod）
- [ ] 单元测试（Jest）
- [ ] API 文档（OpenAPI）
- [ ] 部署配置（Docker/PM2）

### 🚀 未来计划（P2）
- [ ] 事件总线集成
- [ ] AI 查询接口预留
- [ ] 缓存层（Redis）
- [ ] 性能优化

---

## 📚 相关文档

- 📊 [数据库模型](数据库模型.md) - 完整的数据库表结构和字段说明
- 🚀 [项目部署](项目部署.md) - 开发环境配置和部署指南
- 📋 [迁移进度](迁移进度.md) - 数据库迁移进度跟踪
- ✅ [迁移完成总结](迁移完成总结.md) - Auth 域迁移完成报告

### 外部参考
- **项目总览**：`/项目总览.md`
- **原始 SQL 设计**：`/SQL-GUIDE/`（4 个域的完整 SQL）

---

> **更新日志**：随开发进展持续更新。P2 的 AI 圈层设计将在 P1 稳定后补充。

