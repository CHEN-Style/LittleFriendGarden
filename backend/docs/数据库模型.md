# æ•°æ®åº“æ¨¡å‹æ–‡æ¡£

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº† LittleFriendGarden é¡¹ç›®çš„æ•°æ®åº“æ¨¡å‹è®¾è®¡ã€‚

## ğŸ“Š æ¦‚è§ˆ

å½“å‰å·²å®Œæˆçš„æ•°æ®åŸŸï¼š

- âœ… **Auth åŸŸ**ï¼ˆè´¦å·ä¸èº«ä»½ï¼‰- 7 å¼ è¡¨
- â³ **Pet åŸŸ**ï¼ˆå® ç‰©æ¡£æ¡ˆï¼‰- å¾…è®¾è®¡
- â³ **Social åŸŸ**ï¼ˆç¤¾äº¤åŠŸèƒ½ï¼‰- å¾…è®¾è®¡

---

## ğŸ” Auth åŸŸï¼ˆè´¦å·ä¸èº«ä»½ï¼‰

### 1. Userï¼ˆç”¨æˆ·ä¸»è¡¨ï¼‰

**è¡¨å**ï¼š`users`

ç”¨æˆ·è´¦å·ä¸»è¡¨ï¼Œå­˜å‚¨ç”¨æˆ·çš„ç™»å½•å‡­è¯å’ŒåŸºæœ¬ä¿¡æ¯ã€‚

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | çº¦æŸ |
|------|------|------|------|
| `id` | UUID | ç”¨æˆ· ID | ä¸»é”®ï¼Œé»˜è®¤ `gen_random_uuid()` |
| `email` | CITEXT | é‚®ç®± | å”¯ä¸€ï¼Œå¯é€‰ï¼Œå¤§å°å†™ä¸æ•æ„Ÿ |
| `username` | CITEXT | ç”¨æˆ·å | å”¯ä¸€ï¼Œå¯é€‰ï¼Œå¤§å°å†™ä¸æ•æ„Ÿ |
| `phoneE164` | VARCHAR(20) | æ‰‹æœºå· | E.164 æ ¼å¼ |
| `passwordHash` | TEXT | å¯†ç å“ˆå¸Œ | bcrypt åŠ å¯† |
| `isActive` | BOOLEAN | è´¦å·æ˜¯å¦æ¿€æ´» | é»˜è®¤ `true` |
| `settings` | JSONB | ç”¨æˆ·è®¾ç½® | é»˜è®¤ `{}` |
| `createdAt` | TIMESTAMPTZ(6) | åˆ›å»ºæ—¶é—´ | é»˜è®¤ `CURRENT_TIMESTAMP` |
| `updatedAt` | TIMESTAMPTZ(6) | æ›´æ–°æ—¶é—´ | è‡ªåŠ¨æ›´æ–°ï¼ˆè§¦å‘å™¨ï¼‰ |
| `deletedAt` | TIMESTAMPTZ(6) | è½¯åˆ é™¤æ—¶é—´ | å¯é€‰ï¼Œæ”¯æŒè½¯åˆ é™¤ |

**ç´¢å¼•**ï¼š
- `idx_users_email_alive` - `email WHERE deletedAt IS NULL`ï¼ˆéƒ¨åˆ†ç´¢å¼•ï¼‰
- `idx_users_username_alive` - `username WHERE deletedAt IS NULL`ï¼ˆéƒ¨åˆ†ç´¢å¼•ï¼‰

**ç‰¹æ€§**ï¼š
- âœ… CITEXT ç±»å‹ï¼šemail å’Œ username å¤§å°å†™ä¸æ•æ„Ÿ
- âœ… è½¯åˆ é™¤æ”¯æŒ
- âœ… JSONB è®¾ç½®å­—æ®µï¼ˆå­˜å‚¨ç”¨æˆ·åå¥½ï¼‰
- âœ… è‡ªåŠ¨æ›´æ–° `updatedAt`

**ç¤ºä¾‹**ï¼š
```javascript
// åˆ›å»ºç”¨æˆ·ï¼ˆemail å¤§å°å†™ä¸æ•æ„Ÿï¼‰
const user = await prisma.user.create({
  data: {
    email: 'Alice@Example.com',
    username: 'alice',
    passwordHash: await bcrypt.hash('password123', 10)
  }
});

// æŸ¥è¯¢ç”¨æˆ·ï¼ˆå¤§å°å†™ä¸æ•æ„Ÿï¼‰
const found = await prisma.user.findUnique({
  where: { email: 'alice@example.com' } // âœ… å¯ä»¥æ‰¾åˆ°
});
```

---

### 2. UserProfileï¼ˆç”¨æˆ·æ¡£æ¡ˆï¼‰

**è¡¨å**ï¼š`user_profiles`

ç”¨æˆ·å…¬å¼€æ¡£æ¡ˆä¿¡æ¯ï¼Œä¸ `users` è¡¨ 1:1 å…³ç³»ã€‚

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | çº¦æŸ |
|------|------|------|------|
| `userId` | UUID | ç”¨æˆ· ID | ä¸»é”®ï¼Œå¤–é”® â†’ `users.id` |
| `displayName` | VARCHAR(50) | æ˜¾ç¤ºåç§° | å¯é€‰ |
| `bio` | TEXT | ä¸ªäººç®€ä»‹ | å¯é€‰ |
| `avatarUrl` | TEXT | å¤´åƒ URL | å¯é€‰ |
| `bannerUrl` | TEXT | æ¨ªå¹… URL | å¯é€‰ |
| `locationText` | VARCHAR(100) | ä½ç½®æ–‡æœ¬ | å¯é€‰ |
| `birthday` | DATE | ç”Ÿæ—¥ | å¯é€‰ |
| `visibility` | VARCHAR(20) | å¯è§æ€§ | é»˜è®¤ `public` |
| `createdAt` | TIMESTAMPTZ(6) | åˆ›å»ºæ—¶é—´ | é»˜è®¤ `CURRENT_TIMESTAMP` |
| `updatedAt` | TIMESTAMPTZ(6) | æ›´æ–°æ—¶é—´ | è‡ªåŠ¨æ›´æ–°ï¼ˆè§¦å‘å™¨ï¼‰ |
| `deletedAt` | TIMESTAMPTZ(6) | è½¯åˆ é™¤æ—¶é—´ | å¯é€‰ |

**å¯è§æ€§æšä¸¾**ï¼š
- `public` - å…¬å¼€
- `friends` - ä»…å¥½å‹
- `private` - ç§å¯†

**ç‰¹æ€§**ï¼š
- âœ… 1:1 å…³ç³»åˆ° `users`
- âœ… è½¯åˆ é™¤æ”¯æŒ
- âœ… å¯è§æ€§æ§åˆ¶

**ç¤ºä¾‹**ï¼š
```javascript
// åˆ›å»ºç”¨æˆ·æ¡£æ¡ˆ
const profile = await prisma.userProfile.create({
  data: {
    userId: user.id,
    displayName: 'å°èŠ±çš„ä¸»äºº',
    bio: 'å–œæ¬¢å…»çŒ«å…»ç‹— ğŸ±ğŸ¶',
    visibility: 'public'
  }
});

// å…³è”æŸ¥è¯¢
const userWithProfile = await prisma.user.findUnique({
  where: { id: userId },
  include: { profile: true }
});
```

---

### 3. UserIdentityï¼ˆç¬¬ä¸‰æ–¹èº«ä»½ï¼‰

**è¡¨å**ï¼š`user_identities`

ç¬¬ä¸‰æ–¹ç™»å½•èº«ä»½ç»‘å®šï¼ˆOAuthã€Apple Sign-Inã€å¾®ä¿¡ç­‰ï¼‰ã€‚

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | çº¦æŸ |
|------|------|------|------|
| `id` | UUID | èº«ä»½ ID | ä¸»é”®ï¼Œé»˜è®¤ `gen_random_uuid()` |
| `userId` | UUID | ç”¨æˆ· ID | å¤–é”® â†’ `users.id` |
| `provider` | VARCHAR(50) | æä¾›å•† | å¦‚ `google`, `apple`, `wechat` |
| `providerUid` | TEXT | æä¾›å•†ç”¨æˆ· ID | - |
| `meta` | JSONB | å…ƒæ•°æ® | é»˜è®¤ `{}`ï¼Œå­˜å‚¨é¢å¤–ä¿¡æ¯ |
| `createdAt` | TIMESTAMPTZ(6) | åˆ›å»ºæ—¶é—´ | é»˜è®¤ `CURRENT_TIMESTAMP` |
| `updatedAt` | TIMESTAMPTZ(6) | æ›´æ–°æ—¶é—´ | è‡ªåŠ¨æ›´æ–°ï¼ˆè§¦å‘å™¨ï¼‰ |

**å”¯ä¸€çº¦æŸ**ï¼š
- `user_identities_provider_providerUid_key` - `(provider, providerUid)` å”¯ä¸€

**ç´¢å¼•**ï¼š
- `user_identities_userId_idx` - `userId`

**ç‰¹æ€§**ï¼š
- âœ… æ”¯æŒå¤šç§ç¬¬ä¸‰æ–¹ç™»å½•
- âœ… åŒä¸€æä¾›å•†çš„ UID å”¯ä¸€
- âœ… JSONB å…ƒæ•°æ®ï¼ˆå­˜å‚¨ tokenã€profile ç­‰ï¼‰

**ç¤ºä¾‹**ï¼š
```javascript
// ç»‘å®š Google è´¦å·
const identity = await prisma.userIdentity.create({
  data: {
    userId: user.id,
    provider: 'google',
    providerUid: 'google_user_123456',
    meta: {
      email: 'user@gmail.com',
      name: 'Alice'
    }
  }
});

// æŸ¥è¯¢ç”¨æˆ·çš„æ‰€æœ‰ç¬¬ä¸‰æ–¹èº«ä»½
const identities = await prisma.userIdentity.findMany({
  where: { userId: user.id }
});
```

---

### 4. UserFollowï¼ˆå…³æ³¨å…³ç³»ï¼‰

**è¡¨å**ï¼š`user_follows`

ç”¨æˆ·ä¹‹é—´çš„å…³æ³¨å…³ç³»ï¼ˆç²‰ä¸/å…³æ³¨ï¼‰ã€‚

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | çº¦æŸ |
|------|------|------|------|
| `followerUserId` | UUID | å…³æ³¨è€… ID | å¤åˆä¸»é”® 1ï¼Œå¤–é”® â†’ `users.id` |
| `followeeUserId` | UUID | è¢«å…³æ³¨è€… ID | å¤åˆä¸»é”® 2ï¼Œå¤–é”® â†’ `users.id` |
| `createdAt` | TIMESTAMPTZ(6) | å…³æ³¨æ—¶é—´ | é»˜è®¤ `CURRENT_TIMESTAMP` |

**å¤åˆä¸»é”®**ï¼š`(followerUserId, followeeUserId)`

**CHECK çº¦æŸ**ï¼š
- `chk_user_follows_not_self` - `followerUserId <> followeeUserId`ï¼ˆä¸èƒ½å…³æ³¨è‡ªå·±ï¼‰

**ç´¢å¼•**ï¼š
- `user_follows_followee_user_id_idx` - `followeeUserId`ï¼ˆæŸ¥è¯¢ç²‰ä¸åˆ—è¡¨ï¼‰

**ç‰¹æ€§**ï¼š
- âœ… å•å‘å…³æ³¨ï¼ˆç±»ä¼¼ Twitterï¼‰
- âœ… CHECK çº¦æŸé˜²æ­¢è‡ªæˆ‘å…³æ³¨
- âœ… CASCADE åˆ é™¤ï¼ˆç”¨æˆ·åˆ é™¤æ—¶è‡ªåŠ¨åˆ é™¤å…³ç³»ï¼‰

**ç¤ºä¾‹**ï¼š
```javascript
// Alice å…³æ³¨ Bob
await prisma.userFollow.create({
  data: {
    followerUserId: aliceId,
    followeeUserId: bobId
  }
});

// æŸ¥è¯¢ Alice çš„å…³æ³¨åˆ—è¡¨
const following = await prisma.user.findUnique({
  where: { id: aliceId },
  include: {
    following: {
      include: {
        followee: {
          include: { profile: true }
        }
      }
    }
  }
});

// æŸ¥è¯¢ Bob çš„ç²‰ä¸åˆ—è¡¨
const followers = await prisma.user.findUnique({
  where: { id: bobId },
  include: {
    followers: {
      include: {
        follower: {
          include: { profile: true }
        }
      }
    }
  }
});
```

---

### 5. UserBlockï¼ˆå±è”½å…³ç³»ï¼‰

**è¡¨å**ï¼š`user_blocks`

ç”¨æˆ·ä¹‹é—´çš„å±è”½å…³ç³»ã€‚

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | çº¦æŸ |
|------|------|------|------|
| `blockerUserId` | UUID | å±è”½è€… ID | å¤åˆä¸»é”® 1ï¼Œå¤–é”® â†’ `users.id` |
| `blockedUserId` | UUID | è¢«å±è”½è€… ID | å¤åˆä¸»é”® 2ï¼Œå¤–é”® â†’ `users.id` |
| `reason` | TEXT | å±è”½åŸå›  | å¯é€‰ |
| `createdAt` | TIMESTAMPTZ(6) | å±è”½æ—¶é—´ | é»˜è®¤ `CURRENT_TIMESTAMP` |

**å¤åˆä¸»é”®**ï¼š`(blockerUserId, blockedUserId)`

**CHECK çº¦æŸ**ï¼š
- `chk_user_blocks_not_self` - `blockerUserId <> blockedUserId`ï¼ˆä¸èƒ½å±è”½è‡ªå·±ï¼‰

**ç´¢å¼•**ï¼š
- `user_blocks_blocked_user_id_idx` - `blockedUserId`

**ç‰¹æ€§**ï¼š
- âœ… å•å‘å±è”½
- âœ… CHECK çº¦æŸé˜²æ­¢è‡ªæˆ‘å±è”½
- âœ… å¯é€‰çš„å±è”½åŸå› 

**ç¤ºä¾‹**ï¼š
```javascript
// Alice å±è”½ Bob
await prisma.userBlock.create({
  data: {
    blockerUserId: aliceId,
    blockedUserId: bobId,
    reason: 'spam'
  }
});

// æŸ¥è¯¢ Alice å±è”½çš„ç”¨æˆ·åˆ—è¡¨
const blocked = await prisma.user.findUnique({
  where: { id: aliceId },
  include: {
    blocking: {
      include: {
        blocked: {
          select: { id: true, username: true }
        }
      }
    }
  }
});
```

---

### 6. Notificationï¼ˆé€šçŸ¥ä¸­å¿ƒï¼‰

**è¡¨å**ï¼š`notifications`

ç”¨æˆ·é€šçŸ¥ä¸­å¿ƒï¼Œæ”¯æŒå¤šç§ç±»å‹çš„é€šçŸ¥ã€‚

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | çº¦æŸ |
|------|------|------|------|
| `id` | UUID | é€šçŸ¥ ID | ä¸»é”®ï¼Œé»˜è®¤ `gen_random_uuid()` |
| `userId` | UUID | ç”¨æˆ· ID | å¤–é”® â†’ `users.id` |
| `type` | VARCHAR(50) | é€šçŸ¥ç±»å‹ | å¦‚ `system`, `follow`, `like` |
| `payload` | JSONB | é€šçŸ¥å†…å®¹ | é»˜è®¤ `{}` |
| `isRead` | BOOLEAN | æ˜¯å¦å·²è¯» | é»˜è®¤ `false` |
| `createdAt` | TIMESTAMPTZ(6) | åˆ›å»ºæ—¶é—´ | é»˜è®¤ `CURRENT_TIMESTAMP` |
| `readAt` | TIMESTAMPTZ(6) | å·²è¯»æ—¶é—´ | å¯é€‰ |

**é€šçŸ¥ç±»å‹**ï¼š
- `system` - ç³»ç»Ÿé€šçŸ¥
- `follow` - å…³æ³¨é€šçŸ¥
- `like` - ç‚¹èµé€šçŸ¥
- `comment` - è¯„è®ºé€šçŸ¥
- `reminder` - æé†’é€šçŸ¥

**ç´¢å¼•**ï¼š
- `notifications_user_id_is_read_created_at_idx` - `(userId, isRead, createdAt DESC)`ï¼ˆå¤åˆç´¢å¼•ï¼‰

**ç‰¹æ€§**ï¼š
- âœ… çµæ´»çš„ JSONB payload
- âœ… å·²è¯»çŠ¶æ€è·Ÿè¸ª
- âœ… å¤åˆç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢

**ç¤ºä¾‹**ï¼š
```javascript
// åˆ›å»ºå…³æ³¨é€šçŸ¥
await prisma.notification.create({
  data: {
    userId: bobId,
    type: 'follow',
    payload: {
      followerId: aliceId,
      followerName: 'Alice',
      message: 'Alice å…³æ³¨äº†ä½ '
    }
  }
});

// è·å–æœªè¯»é€šçŸ¥
const unread = await prisma.notification.findMany({
  where: {
    userId: bobId,
    isRead: false
  },
  orderBy: { createdAt: 'desc' }
});

// æ ‡è®°ä¸ºå·²è¯»
await prisma.notification.update({
  where: { id: notificationId },
  data: {
    isRead: true,
    readAt: new Date()
  }
});
```

---

### 7. UserTodoï¼ˆç”¨æˆ·å¾…åŠï¼‰

**è¡¨å**ï¼š`user_todos`

ç”¨æˆ·çš„å¾…åŠäº‹é¡¹ï¼Œå¯ä»¥å…³è”å® ç‰©ã€‚

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | çº¦æŸ |
|------|------|------|------|
| `id` | UUID | å¾…åŠ ID | ä¸»é”®ï¼Œé»˜è®¤ `gen_random_uuid()` |
| `userId` | UUID | ç”¨æˆ· ID | å¤–é”® â†’ `users.id` |
| `petId` | UUID | å® ç‰© ID | å¯é€‰ï¼Œå¾…æ·»åŠ å¤–é”® â†’ `pets.id` |
| `title` | VARCHAR(200) | æ ‡é¢˜ | å¿…å¡« |
| `description` | TEXT | æè¿° | å¯é€‰ |
| `priority` | VARCHAR(20) | ä¼˜å…ˆçº§ | é»˜è®¤ `medium` |
| `status` | VARCHAR(20) | çŠ¶æ€ | é»˜è®¤ `pending` |
| `tags` | TEXT[] | æ ‡ç­¾æ•°ç»„ | é»˜è®¤ `[]`ï¼Œæ”¯æŒ GIN ç´¢å¼• |
| `scheduledAt` | TIMESTAMPTZ(6) | è®¡åˆ’æ—¶é—´ | å¯é€‰ |
| `dueAt` | TIMESTAMPTZ(6) | æˆªæ­¢æ—¶é—´ | å¯é€‰ |
| `completedAt` | TIMESTAMPTZ(6) | å®Œæˆæ—¶é—´ | å¯é€‰ |
| `createdAt` | TIMESTAMPTZ(6) | åˆ›å»ºæ—¶é—´ | é»˜è®¤ `CURRENT_TIMESTAMP` |
| `updatedAt` | TIMESTAMPTZ(6) | æ›´æ–°æ—¶é—´ | è‡ªåŠ¨æ›´æ–°ï¼ˆè§¦å‘å™¨ï¼‰ |
| `deletedAt` | TIMESTAMPTZ(6) | è½¯åˆ é™¤æ—¶é—´ | å¯é€‰ |

**ä¼˜å…ˆçº§æšä¸¾**ï¼š
- `low` - ä½
- `medium` - ä¸­
- `high` - é«˜
- `urgent` - ç´§æ€¥

**çŠ¶æ€æšä¸¾**ï¼š
- `pending` - å¾…å¤„ç†
- `done` - å·²å®Œæˆ
- `archived` - å·²å½’æ¡£

**CHECK çº¦æŸ**ï¼š
- `chk_user_todos_priority` - ä¼˜å…ˆçº§å¿…é¡»æ˜¯æšä¸¾å€¼ä¹‹ä¸€
- `chk_user_todos_status` - çŠ¶æ€å¿…é¡»æ˜¯æšä¸¾å€¼ä¹‹ä¸€

**ç´¢å¼•**ï¼š
- `idx_user_todos_user_scheduled_alive` - `(userId, scheduledAt)`ï¼ˆéƒ¨åˆ†ç´¢å¼•ï¼‰
- `idx_user_todos_user_status_alive` - `(userId, status)`ï¼ˆéƒ¨åˆ†ç´¢å¼•ï¼‰
- GIN ç´¢å¼• - `tags`ï¼ˆæ•°ç»„æœç´¢ï¼‰

**ç‰¹æ€§**ï¼š
- âœ… æ ‡ç­¾æ•°ç»„ + GIN ç´¢å¼•ï¼ˆå¿«é€Ÿæœç´¢ï¼‰
- âœ… CHECK çº¦æŸï¼ˆæšä¸¾å€¼éªŒè¯ï¼‰
- âœ… è½¯åˆ é™¤æ”¯æŒ
- âœ… è‡ªåŠ¨æ›´æ–° `updatedAt`
- âœ… å¯å…³è”å® ç‰©

**ç¤ºä¾‹**ï¼š
```javascript
// åˆ›å»ºå¾…åŠ
const todo = await prisma.userTodo.create({
  data: {
    userId: user.id,
    petId: pet.id,
    title: 'å¸¦å°èŠ±å»æ‰“ç–«è‹—',
    description: 'ç‹‚çŠ¬ç–«è‹—ç¬¬äºŒé’ˆ',
    priority: 'high',
    tags: ['å¥åº·', 'ç–«è‹—'],
    scheduledAt: new Date('2025-11-01T10:00:00Z'),
    dueAt: new Date('2025-11-01T18:00:00Z')
  }
});

// æœç´¢åŒ…å«ç‰¹å®šæ ‡ç­¾çš„å¾…åŠ
const todos = await prisma.userTodo.findMany({
  where: {
    userId: user.id,
    tags: {
      has: 'å¥åº·' // åŒ…å«"å¥åº·"æ ‡ç­¾
    },
    deletedAt: null
  }
});

// æœç´¢åŒæ—¶åŒ…å«å¤šä¸ªæ ‡ç­¾
const multiTagTodos = await prisma.userTodo.findMany({
  where: {
    userId: user.id,
    tags: {
      hasEvery: ['å¥åº·', 'ç–«è‹—'] // åŒæ—¶åŒ…å«ä¸¤ä¸ªæ ‡ç­¾
    },
    deletedAt: null
  }
});

// å®Œæˆå¾…åŠ
await prisma.userTodo.update({
  where: { id: todo.id },
  data: {
    status: 'done',
    completedAt: new Date()
  }
});
```

---

## ğŸ”— å…³ç³»å›¾

```
users (ç”¨æˆ·ä¸»è¡¨)
  â”œâ”€ 1:1  â†’ user_profiles (æ¡£æ¡ˆ)
  â”œâ”€ 1:N  â†’ user_identities (ç¬¬ä¸‰æ–¹èº«ä»½)
  â”œâ”€ 1:N  â†’ notifications (é€šçŸ¥)
  â”œâ”€ 1:N  â†’ user_todos (å¾…åŠ)
  â”œâ”€ N:M  â†’ user_follows (å…³æ³¨å…³ç³»)
  â”‚         - following (æˆ‘å…³æ³¨çš„äºº)
  â”‚         - followers (å…³æ³¨æˆ‘çš„äºº)
  â””â”€ N:M  â†’ user_blocks (å±è”½å…³ç³»)
            - blocking (æˆ‘å±è”½çš„äºº)
            - blockedBy (å±è”½æˆ‘çš„äºº)
```

---

## ğŸ› ï¸ æ•°æ®åº“ç‰¹æ€§

### 1. CITEXT ç±»å‹
email å’Œ username ä½¿ç”¨ `CITEXT` ç±»å‹ï¼Œå¤§å°å†™ä¸æ•æ„Ÿï¼š

```javascript
// 'Alice@Example.com' å’Œ 'alice@example.com' è¢«è§†ä¸ºç›¸åŒ
const user = await prisma.user.findUnique({
  where: { email: 'ALICE@EXAMPLE.COM' }
});
// âœ… å¯ä»¥æ‰¾åˆ° email ä¸º 'alice@example.com' çš„ç”¨æˆ·
```

### 2. GIN ç´¢å¼•
`user_todos.tags` ä½¿ç”¨ GIN ç´¢å¼•ï¼Œæ”¯æŒå¿«é€Ÿæ•°ç»„æœç´¢ï¼š

```javascript
// å¿«é€Ÿæœç´¢åŒ…å«ç‰¹å®šæ ‡ç­¾çš„å¾…åŠ
const todos = await prisma.userTodo.findMany({
  where: {
    tags: { has: 'è´­ç‰©' }
  }
});
```

### 3. è½¯åˆ é™¤
å¤šä¸ªè¡¨æ”¯æŒè½¯åˆ é™¤ï¼ˆ`deletedAt` å­—æ®µï¼‰ï¼š

```javascript
// æŸ¥è¯¢æ—¶éœ€è¦æ‰‹åŠ¨è¿‡æ»¤å·²åˆ é™¤è®°å½•
const activeUsers = await prisma.user.findMany({
  where: { deletedAt: null }
});
```

### 4. è‡ªåŠ¨æ›´æ–°æ—¶é—´æˆ³
ä½¿ç”¨ PostgreSQL è§¦å‘å™¨è‡ªåŠ¨æ›´æ–° `updatedAt`ï¼š

```sql
CREATE OR REPLACE FUNCTION set_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = CURRENT_TIMESTAMP;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

### 5. CHECK çº¦æŸ
å¤šä¸ªè¡¨ä½¿ç”¨ CHECK çº¦æŸç¡®ä¿æ•°æ®å®Œæ•´æ€§ï¼š

```sql
-- ä¸èƒ½å…³æ³¨è‡ªå·±
ALTER TABLE user_follows
  ADD CONSTRAINT chk_user_follows_not_self
  CHECK (follower_user_id <> followee_user_id);

-- ä¼˜å…ˆçº§æšä¸¾
ALTER TABLE user_todos
  ADD CONSTRAINT chk_user_todos_priority
  CHECK (priority IN ('low', 'medium', 'high', 'urgent'));
```

---

## ğŸ“ æ³¨æ„äº‹é¡¹

### 1. petId å¤–é”®å¾…æ·»åŠ 
`user_todos.pet_id` ç›®å‰æ²¡æœ‰å¤–é”®çº¦æŸï¼Œéœ€è¦åœ¨ Pet åŸŸå®Œæˆåæ·»åŠ ï¼š

```sql
ALTER TABLE user_todos
  ADD CONSTRAINT fk_user_todos_pet
  FOREIGN KEY (pet_id) REFERENCES pets(id) ON DELETE SET NULL;
```

### 2. è½¯åˆ é™¤è¿‡æ»¤
Prisma ä¸ä¼šè‡ªåŠ¨è¿‡æ»¤ `deletedAt IS NOT NULL` çš„è®°å½•ï¼Œéœ€è¦ï¼š
- åœ¨æŸ¥è¯¢æ—¶æ‰‹åŠ¨æ·»åŠ  `where: { deletedAt: null }`
- æˆ–ä½¿ç”¨ Prisma ä¸­é—´ä»¶å…¨å±€å¤„ç†

### 3. æ—¶é—´æˆ³æ—¶åŒº
æ‰€æœ‰æ—¶é—´å­—æ®µä½¿ç”¨ `TIMESTAMPTZ(6)` ç±»å‹ï¼š
- è‡ªåŠ¨å¤„ç†æ—¶åŒºè½¬æ¢
- åœ¨ JavaScript ä¸­ä»¥ `Date` å¯¹è±¡è¡¨ç¤º

### 4. JSONB å­—æ®µ
ä»¥ä¸‹å­—æ®µä½¿ç”¨ JSONB ç±»å‹ï¼Œæ”¯æŒçµæ´»çš„æ•°æ®ç»“æ„ï¼š
- `users.settings` - ç”¨æˆ·è®¾ç½®
- `user_identities.meta` - ç¬¬ä¸‰æ–¹èº«ä»½å…ƒæ•°æ®
- `notifications.payload` - é€šçŸ¥å†…å®¹

å¯ä»¥ä½¿ç”¨ Prisma çš„ JSON æ“ä½œç¬¦è¿›è¡ŒæŸ¥è¯¢ï¼š

```javascript
// æŸ¥è¯¢ settings ä¸­ç‰¹å®šå­—æ®µ
const users = await prisma.user.findMany({
  where: {
    settings: {
      path: ['theme'],
      equals: 'dark'
    }
  }
});
```

---

## ğŸš€ ä¸‹ä¸€æ­¥

- [ ] **Pet åŸŸ**ï¼šå® ç‰©æ¡£æ¡ˆã€ç´ ææ± ã€äº‹ä»¶è®°å½•ã€æé†’
- [ ] **Social åŸŸ**ï¼šå¸–å­ã€è¯„è®ºã€äº’åŠ¨ã€è¯é¢˜
- [ ] **åç«¯æœåŠ¡å±‚**ï¼šRepositoryã€Serviceã€Controllerã€ä¸­é—´ä»¶

---

> **æœ€åæ›´æ–°**ï¼š2025-10-30  
> **ç‰ˆæœ¬**ï¼šv1.0.0  
> **çŠ¶æ€**ï¼šâœ… Auth åŸŸå·²å®Œæˆ

