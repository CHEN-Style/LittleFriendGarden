# é¡¹ç›®éƒ¨ç½²æŒ‡å—

> **é¡¹ç›®**ï¼šå°å‹èŠ±å›­ï¼ˆLittleFriendGardenï¼‰  
> **æ›´æ–°**ï¼š2025-10-30

æœ¬æ–‡æ¡£ç»Ÿä¸€ç®¡ç†åç«¯å¼€å‘å’Œéƒ¨ç½²ç›¸å…³çš„æ‰€æœ‰å†…å®¹ã€‚

---

## ğŸ“‹ ç›®å½•

- [å¼€å‘ç¯å¢ƒå‡†å¤‡](#å¼€å‘ç¯å¢ƒå‡†å¤‡)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [Prisma å¸¸ç”¨å‘½ä»¤](#prisma-å¸¸ç”¨å‘½ä»¤)
- [æ•°æ®åº“ç®¡ç†](#æ•°æ®åº“ç®¡ç†)
- [éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ](#éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## ğŸ› ï¸ å¼€å‘ç¯å¢ƒå‡†å¤‡

### å¿…éœ€è½¯ä»¶

- **Node.js** 18+ ([ä¸‹è½½åœ°å€](https://nodejs.org/))
- **PostgreSQL** 13+ ([ä¸‹è½½åœ°å€](https://www.postgresql.org/download/))
- **Git** ([ä¸‹è½½åœ°å€](https://git-scm.com/))

### æ¨èå·¥å…·

- **Prisma Studio** - æ•°æ®åº“å¯è§†åŒ–ç®¡ç†ï¼ˆPrisma å†…ç½®ï¼‰
- **DBeaver** / **pgAdmin** - PostgreSQL å®¢æˆ·ç«¯
- **Postman** / **Insomnia** - API æµ‹è¯•å·¥å…·

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å…‹éš†é¡¹ç›®

```bash
git clone <repository-url>
cd LittleFriendGarden/backend
```

### 2. å®‰è£…ä¾èµ–

```bash
npm install
```

### 3. é…ç½®ç¯å¢ƒå˜é‡

å¤åˆ¶ `.env.example` åˆ° `.env` å¹¶ä¿®æ”¹é…ç½®ï¼š

```bash
cp .env.example .env
```

ç¼–è¾‘ `.env` æ–‡ä»¶ï¼š

```env
# æ•°æ®åº“è¿æ¥
DATABASE_URL="postgresql://postgres:123456@localhost:5432/db-LFG?schema=public"

# JWT é…ç½®
JWT_SECRET="your-secret-key-change-in-production"
JWT_EXPIRES_IN="7d"

# æœåŠ¡é…ç½®
PORT=3000
NODE_ENV=development
```

> âš ï¸ **å®‰å…¨æç¤º**ï¼šç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨å¼ºéšæœºå¯†é’¥ï¼

### 4. æ•°æ®åº“å‡†å¤‡

#### 4.1 åˆ›å»ºæ•°æ®åº“

è¿æ¥åˆ° PostgreSQL å¹¶æ‰§è¡Œï¼š

```sql
CREATE DATABASE "db-LFG";
```

#### 4.2 å¯ç”¨å¿…è¦çš„æ‰©å±•

è¿æ¥åˆ° `db-LFG` æ•°æ®åº“å¹¶æ‰§è¡Œï¼š

```sql
-- UUID ç”Ÿæˆæ”¯æŒ
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- ä¸åŒºåˆ†å¤§å°å†™çš„æ–‡æœ¬ç±»å‹ï¼ˆç”¨äº email/usernameï¼‰
CREATE EXTENSION IF NOT EXISTS citext;
```

> ğŸ’¡ **æç¤º**ï¼šè¿™äº›æ‰©å±•åªéœ€æ‰§è¡Œä¸€æ¬¡ï¼ŒPrisma è¿ç§»ä¼šè‡ªåŠ¨å¤„ç†è¡¨ç»“æ„ã€‚

### 5. è¿è¡Œæ•°æ®åº“è¿ç§»

```bash
npm run prisma:migrate
```

è¿™å°†ï¼š
- åˆ›å»ºæ‰€æœ‰æ•°æ®åº“è¡¨
- åº”ç”¨çº¦æŸå’Œç´¢å¼•
- è®¾ç½®è§¦å‘å™¨ï¼ˆå¦‚ `updated_at` è‡ªåŠ¨æ›´æ–°ï¼‰

### 6. éªŒè¯æ•°æ®åº“

è¿è¡ŒéªŒè¯è„šæœ¬ï¼Œç¡®ä¿æ‰€æœ‰è¡¨éƒ½æ­£ç¡®åˆ›å»ºï¼š

```bash
npm run db:verify
```

ä½ åº”è¯¥çœ‹åˆ°ç±»ä¼¼è¾“å‡ºï¼š

```
âœ… User - è¡¨ç»“æ„æ­£ç¡®
âœ… UserProfile - è¡¨ç»“æ„æ­£ç¡®
âœ… UserIdentity - è¡¨ç»“æ„æ­£ç¡®
âœ… UserFollow - è¡¨ç»“æ„æ­£ç¡®
âœ… UserBlock - è¡¨ç»“æ„æ­£ç¡®
âœ… Notification - è¡¨ç»“æ„æ­£ç¡®
âœ… UserTodo - è¡¨ç»“æ„æ­£ç¡®
```

### 7. å¯åŠ¨å¼€å‘æœåŠ¡å™¨

```bash
npm run dev
```

æœåŠ¡å°†åœ¨ `http://localhost:3000` å¯åŠ¨ã€‚

---

## ğŸ”§ Prisma å¸¸ç”¨å‘½ä»¤

### å¼€å‘é˜¶æ®µ

```bash
# ç”Ÿæˆ Prisma Clientï¼ˆä¿®æ”¹ schema åå¿…é¡»æ‰§è¡Œï¼‰
npx prisma generate

# åˆ›å»ºæ–°çš„è¿ç§»ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
npx prisma migrate dev --name <migration_name>

# æŸ¥çœ‹è¿ç§»çŠ¶æ€
npx prisma migrate status

# æ ¼å¼åŒ– schema æ–‡ä»¶
npx prisma format

# æ‰“å¼€ Prisma Studioï¼ˆå¯è§†åŒ–æ•°æ®åº“ç®¡ç†ï¼‰
npx prisma studio
```

### æ•°æ®åº“é‡ç½®

```bash
# âš ï¸ é‡ç½®æ•°æ®åº“ï¼ˆä¼šåˆ é™¤æ‰€æœ‰æ•°æ®ï¼‰
npx prisma migrate reset

# ç­‰åŒäºï¼šåˆ é™¤æ‰€æœ‰è¡¨ â†’ é‡æ–°è¿è¡Œæ‰€æœ‰è¿ç§» â†’ æ‰§è¡Œ seedï¼ˆå¦‚æœæœ‰ï¼‰
```

### ç”Ÿäº§éƒ¨ç½²

```bash
# éƒ¨ç½²è¿ç§»åˆ°ç”Ÿäº§ç¯å¢ƒï¼ˆä¸åˆ›å»ºæ–°è¿ç§»ï¼‰
npx prisma migrate deploy

# ç”Ÿæˆ Prisma Clientï¼ˆCI/CD ç¯å¢ƒï¼‰
npx prisma generate
```

---

## ğŸ—„ï¸ æ•°æ®åº“ç®¡ç†

### æŸ¥çœ‹æ•°æ®åº“ä¿¡æ¯

```bash
# ä½¿ç”¨ psql è¿æ¥
psql postgresql://postgres:123456@localhost:5432/db-LFG

# æŸ¥çœ‹æ‰€æœ‰è¡¨
\dt

# æŸ¥çœ‹è¡¨ç»“æ„
\d users
\d user_profiles

# æŸ¥çœ‹ç´¢å¼•
\di

# é€€å‡º
\q
```

### æ•°æ®åº“å¤‡ä»½

```bash
# å¤‡ä»½æ•´ä¸ªæ•°æ®åº“
pg_dump -U postgres -d db-LFG > backup_$(date +%Y%m%d).sql

# æ¢å¤æ•°æ®åº“
psql -U postgres -d db-LFG < backup_20251030.sql
```

### è¿ç§»ç®¡ç†

**åˆ›å»ºæ–°è¿ç§»**ï¼š

```bash
# 1. ä¿®æ”¹ prisma/schema.prisma
# 2. åˆ›å»ºè¿ç§»
npx prisma migrate dev --name add_pet_domain

# 3. ï¼ˆå¦‚æœéœ€è¦ï¼‰ç¼–è¾‘ç”Ÿæˆçš„ migration.sql æ·»åŠ çº¦æŸ
# 4. éªŒè¯è¿ç§»
npm run db:verify
```

**è¿ç§»æœ€ä½³å®è·µ**ï¼š

- âœ… æ¯ä¸ªè¿ç§»ä¸“æ³¨ä¸€ä¸ªåŠŸèƒ½åŸŸï¼ˆå¦‚ `auth`, `pet`ï¼‰
- âœ… ä½¿ç”¨æè¿°æ€§åç§°ï¼ˆå¦‚ `add_pet_weight_tracking`ï¼‰
- âœ… å¤æ‚çº¦æŸåœ¨ `migration.sql` ä¸­æ‰‹åŠ¨æ·»åŠ 
- âœ… è¿ç§»å‰å¤‡ä»½æ•°æ®åº“

---

## ğŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

### ç¯å¢ƒå˜é‡é…ç½®

ç”Ÿäº§ç¯å¢ƒ `.env` ç¤ºä¾‹ï¼š

```env
# æ•°æ®åº“ï¼ˆä½¿ç”¨è¿æ¥æ± ï¼‰
DATABASE_URL="postgresql://user:password@db.example.com:5432/lfg_prod?schema=public&connection_limit=10"

# JWTï¼ˆä½¿ç”¨å¼ºéšæœºå¯†é’¥ï¼‰
JWT_SECRET="<ç”Ÿæˆçš„ 64 å­—ç¬¦éšæœºå­—ç¬¦ä¸²>"
JWT_EXPIRES_IN="7d"

# æœåŠ¡
PORT=3000
NODE_ENV=production

# æ—¥å¿—
LOG_LEVEL=info
```

**ç”Ÿæˆå®‰å…¨å¯†é’¥**ï¼š

```bash
# Linux/Mac
openssl rand -base64 64

# Node.js
node -e "console.log(require('crypto').randomBytes(64).toString('base64'))"
```

### éƒ¨ç½²æ­¥éª¤

#### 1. å®‰è£…ä¾èµ–ï¼ˆç”Ÿäº§æ¨¡å¼ï¼‰

```bash
npm ci --omit=dev
```

#### 2. ç”Ÿæˆ Prisma Client

```bash
npx prisma generate
```

#### 3. è¿è¡Œè¿ç§»

```bash
npx prisma migrate deploy
```

#### 4. å¯åŠ¨åº”ç”¨

```bash
npm start
```

### ä½¿ç”¨ PM2ï¼ˆæ¨èï¼‰

```bash
# å®‰è£… PM2
npm install -g pm2

# å¯åŠ¨åº”ç”¨
pm2 start npm --name "lfg-backend" -- start

# æŸ¥çœ‹çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs lfg-backend

# è®¾ç½®å¼€æœºè‡ªå¯
pm2 startup
pm2 save
```

### Docker éƒ¨ç½²

```dockerfile
# Dockerfile ç¤ºä¾‹
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --omit=dev

COPY . .
RUN npx prisma generate

EXPOSE 3000

CMD ["npm", "start"]
```

```bash
# æ„å»ºé•œåƒ
docker build -t lfg-backend .

# è¿è¡Œå®¹å™¨
docker run -d \
  --name lfg-backend \
  -p 3000:3000 \
  --env-file .env.production \
  lfg-backend
```

---

## ğŸ“¦ NPM è„šæœ¬è¯´æ˜

| è„šæœ¬ | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ |
|------|------|----------|
| `npm run dev` | å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼ˆçƒ­é‡è½½ï¼‰ | æœ¬åœ°å¼€å‘ |
| `npm start` | å¯åŠ¨ç”Ÿäº§æœåŠ¡å™¨ | ç”Ÿäº§ç¯å¢ƒ |
| `npm run prisma:migrate` | è¿è¡Œæ•°æ®åº“è¿ç§» | å¼€å‘/éƒ¨ç½² |
| `npm run prisma:generate` | ç”Ÿæˆ Prisma Client | ä¿®æ”¹ schema å |
| `npm run prisma:studio` | æ‰“å¼€ Prisma Studio | æ•°æ®åº“ç®¡ç† |
| `npm run db:verify` | éªŒè¯æ•°æ®åº“è¡¨ç»“æ„ | è¿ç§»åéªŒè¯ |

---

## â“ å¸¸è§é—®é¢˜

### 1. æ•°æ®åº“è¿æ¥å¤±è´¥

**é”™è¯¯**ï¼š`Error: P1001: Can't reach database server`

**è§£å†³**ï¼š
- æ£€æŸ¥ PostgreSQL æœåŠ¡æ˜¯å¦è¿è¡Œ
- éªŒè¯ `.env` ä¸­çš„è¿æ¥å­—ç¬¦ä¸²
- ç¡®è®¤æ•°æ®åº“å·²åˆ›å»º

```bash
# æ£€æŸ¥ PostgreSQL çŠ¶æ€ï¼ˆLinuxï¼‰
sudo systemctl status postgresql

# æ£€æŸ¥ PostgreSQL çŠ¶æ€ï¼ˆMacï¼‰
brew services list

# æ£€æŸ¥ PostgreSQL çŠ¶æ€ï¼ˆWindowsï¼‰
# æ‰“å¼€æœåŠ¡ç®¡ç†å™¨ï¼ŒæŸ¥æ‰¾ PostgreSQL
```

### 2. æ‰©å±•æœªå®‰è£…

**é”™è¯¯**ï¼š`type "citext" does not exist`

**è§£å†³**ï¼š

```sql
-- è¿æ¥åˆ°æ•°æ®åº“åæ‰§è¡Œ
CREATE EXTENSION IF NOT EXISTS citext;
```

### 3. Prisma Client æœªç”Ÿæˆ

**é”™è¯¯**ï¼š`Cannot find module '@prisma/client'`

**è§£å†³**ï¼š

```bash
npx prisma generate
```

### 4. è¿ç§»å†²çª

**é”™è¯¯**ï¼š`Migration ... failed to apply`

**è§£å†³**ï¼ˆå¼€å‘ç¯å¢ƒï¼‰ï¼š

```bash
# æ–¹æ³• 1ï¼šé‡ç½®æ•°æ®åº“ï¼ˆä¼šä¸¢å¤±æ•°æ®ï¼‰
npx prisma migrate reset

# æ–¹æ³• 2ï¼šæ‰‹åŠ¨è§£å†³å†²çªåé‡è¯•
npx prisma migrate resolve --applied <migration_name>
npx prisma migrate deploy
```

### 5. ç«¯å£å·²è¢«å ç”¨

**é”™è¯¯**ï¼š`Error: listen EADDRINUSE: address already in use :::3000`

**è§£å†³**ï¼š

```bash
# æŸ¥æ‰¾å ç”¨ç«¯å£çš„è¿›ç¨‹
# Linux/Mac
lsof -i :3000

# Windows
netstat -ano | findstr :3000

# æ€æ­»è¿›ç¨‹æˆ–ä¿®æ”¹ .env ä¸­çš„ PORT
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- ğŸ“Š [æ•°æ®åº“æ¨¡å‹](æ•°æ®åº“æ¨¡å‹.md) - å®Œæ•´çš„è¡¨ç»“æ„è¯´æ˜
- ğŸ› ï¸ [åç«¯æŠ€æœ¯æ–¹æ¡ˆ](åç«¯æŠ€æœ¯æ–¹æ¡ˆ.md) - æŠ€æœ¯é€‰å‹å’Œæ¶æ„
- ğŸ“‹ [è¿ç§»è¿›åº¦](è¿ç§»è¿›åº¦.md) - å½“å‰å¼€å‘è¿›åº¦

---

## ğŸ”„ æ›´æ–°æ—¥å¿—

- **2025-10-30** - åˆå§‹ç‰ˆæœ¬ï¼ŒåŒ…å«å¼€å‘ç¯å¢ƒå’Œéƒ¨ç½²æŒ‡å—
- åç»­å°†æ·»åŠ ï¼šCI/CD é…ç½®ã€ç›‘æ§é…ç½®ã€æ€§èƒ½ä¼˜åŒ–

---

> ğŸ’¡ **æç¤º**ï¼šéƒ¨ç½²å‰è¯·åŠ¡å¿…é˜…è¯» [åç«¯æŠ€æœ¯æ–¹æ¡ˆ](åç«¯æŠ€æœ¯æ–¹æ¡ˆ.md) äº†è§£æ¶æ„è®¾è®¡ã€‚

