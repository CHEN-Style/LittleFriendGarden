# 宠物记录（健康 / 喂养 / 体重等）P1.0

## 目标

以**可扩展**为原则，提供一张**通用事件时间轴** + 若干**专用明细表**，既能快速查询，又便于后续新增事件类型（最少迁移）。

## 表与关系

- **pets** 1 — n **pet_events**（通用事件流，做“时间轴/总表”）
- **pet_events.event_type** 指向不同专用表的记录（应用层约束）
- 专用表（示例）：**pet_weights / pet_feedings / pet_vaccinations / pet_medications**
- 通用提醒：**reminders**（与用户、宠物关联）

---

## PostgreSQL DDL（可直接执行）

```sql
-- 复用：自动更新时间戳函数
CREATE OR REPLACE FUNCTION set_updated_at()
RETURNS TRIGGER AS $$
BEGIN NEW.updated_at = now(); RETURN NEW; END;
$$ LANGUAGE plpgsql;

-- 为通用事件类型创建枚举（可按需扩展）
DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'pet_event_type') THEN
    CREATE TYPE pet_event_type AS ENUM (
      'weight', 'feeding', 'vaccination', 'medication',
      'checkup', 'grooming', 'toilet', 'other'
    );
  END IF;
END$$;

-- 1) pet_events：通用事件时间轴（做统一检索入口）
CREATE TABLE IF NOT EXISTS pet_events (
  id           UUID PRIMARY KEY,
  pet_id       UUID NOT NULL REFERENCES pets(id) ON DELETE CASCADE,
  event_type   pet_event_type NOT NULL,
  occurred_at  TIMESTAMPTZ    NOT NULL,
  payload      JSONB           NOT NULL DEFAULT '{}'::jsonb, -- 自由扩展（轻量查询）
  created_at   TIMESTAMPTZ     NOT NULL DEFAULT now(),
  deleted_at   TIMESTAMPTZ
);

-- 常用检索：按宠物、按类型、倒序时间线
CREATE INDEX IF NOT EXISTS idx_pet_events_pet_time
  ON pet_events (pet_id, occurred_at DESC) WHERE deleted_at IS NULL;

CREATE INDEX IF NOT EXISTS idx_pet_events_type_time
  ON pet_events (event_type, occurred_at DESC) WHERE deleted_at IS NULL;

CREATE INDEX IF NOT EXISTS idx_pet_events_payload_gin
  ON pet_events USING GIN (payload);

-- 可选：时间分区（推荐生产使用，按月/周）
-- ALTER TABLE pet_events PARTITION BY RANGE (occurred_at);
-- CREATE TABLE pet_events_2025_10 PARTITION OF pet_events
--   FOR VALUES FROM ('2025-10-01') TO ('2025-11-01');

-------------------------------------------------------
-- 专用表：提供结构化字段，便于统计与精确查询
-------------------------------------------------------

-- 2) pet_weights：体重记录
CREATE TABLE IF NOT EXISTS pet_weights (
  id          UUID PRIMARY KEY,
  pet_id      UUID NOT NULL REFERENCES pets(id) ON DELETE CASCADE,
  kg          NUMERIC(5,2) NOT NULL CHECK (kg > 0),
  measured_at TIMESTAMPTZ  NOT NULL,
  note        TEXT,
  created_at  TIMESTAMPTZ  NOT NULL DEFAULT now()
);
CREATE INDEX IF NOT EXISTS idx_pet_weights_time ON pet_weights (pet_id, measured_at DESC);

-- 3) pet_feedings：喂养记录
CREATE TABLE IF NOT EXISTS pet_feedings (
  id          UUID PRIMARY KEY,
  pet_id      UUID NOT NULL REFERENCES pets(id) ON DELETE CASCADE,
  brand       TEXT,
  amount_gram INT CHECK (amount_gram IS NULL OR amount_gram >= 0),
  meal_type   TEXT, -- breakfast/dinner/snack 等
  fed_at      TIMESTAMPTZ NOT NULL,
  note        TEXT,
  created_at  TIMESTAMPTZ  NOT NULL DEFAULT now()
);
CREATE INDEX IF NOT EXISTS idx_pet_feedings_time ON pet_feedings (pet_id, fed_at DESC);

-- 4) pet_vaccinations：疫苗记录
CREATE TABLE IF NOT EXISTS pet_vaccinations (
  id          UUID PRIMARY KEY,
  pet_id      UUID NOT NULL REFERENCES pets(id) ON DELETE CASCADE,
  vaccine_name TEXT      NOT NULL,
  dose_no     INT,                     -- 第几针
  done_at     TIMESTAMPTZ NOT NULL,
  next_due_at TIMESTAMPTZ,
  clinic      TEXT,
  note        TEXT,
  created_at  TIMESTAMPTZ NOT NULL DEFAULT now()
);
CREATE INDEX IF NOT EXISTS idx_pet_vaccinations_done ON pet_vaccinations (pet_id, done_at DESC);
CREATE INDEX IF NOT EXISTS idx_pet_vaccinations_next ON pet_vaccinations (pet_id, next_due_at);

-- 5) pet_medications：用药记录（疗程）
CREATE TABLE IF NOT EXISTS pet_medications (
  id         UUID PRIMARY KEY,
  pet_id     UUID NOT NULL REFERENCES pets(id) ON DELETE CASCADE,
  drug_name  TEXT NOT NULL,
  dose       TEXT,                   -- e.g. "2ml q12h"
  start_at   TIMESTAMPTZ NOT NULL,
  end_at     TIMESTAMPTZ,
  note       TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
CREATE INDEX IF NOT EXISTS idx_pet_medications_range ON pet_medications (pet_id, start_at DESC, end_at);

-------------------------------------------------------
-- 通用提醒（与用户、宠物关联）
-------------------------------------------------------

-- 6) reminders：提醒（疫苗/驱虫/体检/洗护/喂药...）
CREATE TABLE IF NOT EXISTS reminders (
  id            UUID PRIMARY KEY,
  user_id       UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  pet_id        UUID NOT NULL REFERENCES pets(id)  ON DELETE CASCADE,
  remind_type   TEXT NOT NULL,     -- vaccine/deworm/checkup/grooming/feeding/medication/other
  title         TEXT NOT NULL,
  scheduled_at  TIMESTAMPTZ NOT NULL,
  repeat_rule   TEXT,              -- iCal RRULE 或自定义JSON
  status        TEXT NOT NULL DEFAULT 'pending', -- pending/done/cancelled
  payload       JSONB NOT NULL DEFAULT '{}'::jsonb,
  created_at    TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at    TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_reminders_user_time ON reminders (user_id, scheduled_at);
CREATE INDEX IF NOT EXISTS idx_reminders_pet_time  ON reminders (pet_id, scheduled_at);

CREATE TRIGGER trg_reminders_updated_at
BEFORE UPDATE ON reminders
FOR EACH ROW EXECUTE FUNCTION set_updated_at();

```

---

## 使用建议（最少迁移思路）

- **统一入口查询**：前端时间线优先查 `pet_events`（分页/筛类型），点击某条再跳到专用表详情（通过 `payload` 或应用层映射）。
- **新增事件类型**：只需给 `pet_event_type` 扩容（或改用字典表）+ 新增专用表（可选），`pet_events` 保持不变。
- **统计与报表**：曲线图等直接用专用表（如 `pet_weights`、`pet_feedings`），避免从 JSONB 聚合。
- **提醒联动**：`reminders` 与 `pet_vaccinations.next_due_at`、`pet_medications` 结合，服务端定时器触发通知。
- **分区策略**：`pet_events` 建议上线即按月分区；专用表视规模再开启（通常可后置）。