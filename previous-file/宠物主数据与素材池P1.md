# 宠物主数据与素材池 P1.0

## 目标

承载**宠物主数据**（真实世界实体）与**素材池**（照片/视频/文档+标签），支持多成员共享、时间线检索与后续 P2 的 AI 召回。

## 表与关系

- **pets**（宠物主数据）1 — n **pet_owners**（多成员家庭/共享）
- **pets** 1 — n **pet_assets**（素材池：照片/视频/文档）

---

## PostgreSQL DDL（可直接执行）

```sql
-- 通用：自动更新时间戳（与 1) 账号与关系 复用）
CREATE OR REPLACE FUNCTION set_updated_at()
RETURNS TRIGGER AS $$
BEGIN NEW.updated_at = now(); RETURN NEW; END;
$$ LANGUAGE plpgsql;

-- 1) pets：宠物主数据
CREATE TABLE IF NOT EXISTS pets (
  id               UUID PRIMARY KEY,
  primary_owner_id UUID NOT NULL REFERENCES users(id) ON DELETE RESTRICT,
  name             TEXT NOT NULL,
  species          TEXT NOT NULL,                 -- 猫/犬/...（可后续字典化）
  breed            TEXT,
  sex              TEXT,                          -- male/female/unknown（可后续 enum）
  birthday         DATE,
  chip_no          TEXT,
  avatar_url       TEXT,
  profile          JSONB        NOT NULL DEFAULT '{}'::jsonb, -- 绝育/过敏史/保险/性格标签等
  created_at       TIMESTAMPTZ  NOT NULL DEFAULT now(),
  updated_at       TIMESTAMPTZ  NOT NULL DEFAULT now(),
  deleted_at       TIMESTAMPTZ
);

-- 常用检索：按主人/活跃宠物/性格标签等
CREATE INDEX IF NOT EXISTS idx_pets_owner ON pets (primary_owner_id) WHERE deleted_at IS NULL;
CREATE INDEX IF NOT EXISTS idx_pets_active ON pets (created_at) WHERE deleted_at IS NULL;
CREATE INDEX IF NOT EXISTS idx_pets_profile_gin ON pets USING GIN (profile); -- JSONB 键检索

CREATE TRIGGER trg_pets_updated_at
BEFORE UPDATE ON pets
FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- 2) pet_owners：宠物-用户多成员关系（共享/照护）
CREATE TABLE IF NOT EXISTS pet_owners (
  pet_id   UUID NOT NULL REFERENCES pets(id)  ON DELETE CASCADE,
  user_id  UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  role     TEXT NOT NULL DEFAULT 'owner',     -- owner/family/sitter...
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  PRIMARY KEY (pet_id, user_id)
);

CREATE INDEX IF NOT EXISTS idx_pet_owners_user ON pet_owners (user_id);
CREATE INDEX IF NOT EXISTS idx_pet_owners_pet  ON pet_owners (pet_id);

-- 3) pet_assets：素材池（照片/视频/文档）
CREATE TABLE IF NOT EXISTS pet_assets (
  id               UUID PRIMARY KEY,
  pet_id           UUID NOT NULL REFERENCES pets(id) ON DELETE CASCADE,
  uploader_user_id UUID NOT NULL REFERENCES users(id) ON DELETE SET NULL,
  type             TEXT NOT NULL,                     -- photo/video/doc
  url              TEXT NOT NULL,
  meta             JSONB NOT NULL DEFAULT '{}'::jsonb, -- exif/时长/宽高/模型标签等
  tags             TEXT[] NOT NULL DEFAULT '{}',       -- 轻量标签
  created_at       TIMESTAMPTZ NOT NULL DEFAULT now(),
  deleted_at       TIMESTAMPTZ
);

-- 常用检索：按宠物/时间线/标签
CREATE INDEX IF NOT EXISTS idx_pet_assets_pet_time ON pet_assets (pet_id, created_at DESC) WHERE deleted_at IS NULL;
CREATE INDEX IF NOT EXISTS idx_pet_assets_tags_gin ON pet_assets USING GIN (tags);
CREATE INDEX IF NOT EXISTS idx_pet_assets_meta_gin ON pet_assets USING GIN (meta);

-- 约束示例：限定 type 合法值（可选）
DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'asset_type') THEN
    CREATE TYPE asset_type AS ENUM ('photo', 'video', 'doc');
  END IF;
END$$;

-- 如果采用 ENUM，可改为：
-- ALTER TABLE pet_assets ALTER COLUMN type TYPE asset_type USING type::asset_type;

```

### 说明要点

- **pets**：保持“真实实体”纯净，**profile(JSONB)** 预留可变信息（绝育/过敏/保险/性格标签等），避免列爆炸。
- **pet_owners**：支持多成员共享（owner/family/sitter），后续权限校验统一走此表。
- **pet_assets**：作为 **P2 的素材池**；提前保留 `meta(JSONB)` 与 `tags(TEXT[])`，方便图像标签、搜索与后续向量化对接。
- **软删除**：`deleted_at` 便于回收站/合规；常用索引加 `WHERE deleted_at IS NULL`。
- **索引策略**：时间线 `(pet_id, created_at DESC)`；`GIN(tags/meta/profile)` 支撑丰富筛选。
- **一致性**：外键 `ON DELETE CASCADE`（删宠物→素材自动清理），`ON DELETE SET NULL`（删用户→保留资产记录但 uploader 置空，可按需改为 CASCADE）。

> 这批表即可支撑：宠物档案、家庭共享、素材沉淀与按时间/标签检索；为后续“动物朋友圈/城市”直接复用 pets 与 pet_assets 打基础。
>