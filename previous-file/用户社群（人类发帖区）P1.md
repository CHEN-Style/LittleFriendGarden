# 用户社群（人类发帖区）P1.0

## 目标

承载**人类用户创作与互动**：发帖、评论、点赞、收藏、话题；支持时间线/话题页/个人主页检索，预留扩展与软删除。

## 表与关系

- **users** 1 — n **posts**（作者）
- **posts** 1 — n **comments**
- **posts/comments** ← n **reactions**（点赞等）
- **users** n — n **posts** via **bookmarks**（收藏）
- **posts** n — n **topics** via **post_topics**

---

## PostgreSQL DDL（可直接执行）

```sql
-- 复用更新时间戳函数
CREATE OR REPLACE FUNCTION set_updated_at()
RETURNS TRIGGER AS $$
BEGIN NEW.updated_at = now(); RETURN NEW; END;
$$ LANGUAGE plpgsql;

-------------------------------------------------------
-- 1) posts：人类用户发帖
-------------------------------------------------------
CREATE TABLE IF NOT EXISTS posts (
  id            UUID PRIMARY KEY,
  author_user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  text          TEXT NOT NULL,
  media         JSONB        NOT NULL DEFAULT '[]'::jsonb,  -- [{url,type,ratio,...}]
  topics        TEXT[]       NOT NULL DEFAULT '{}',         -- 轻量标签（可与话题字典并存）
  visibility    TEXT         NOT NULL DEFAULT 'public',     -- public/friends/private
  created_at    TIMESTAMPTZ  NOT NULL DEFAULT now(),
  updated_at    TIMESTAMPTZ  NOT NULL DEFAULT now(),
  deleted_at    TIMESTAMPTZ
);

CREATE INDEX IF NOT EXISTS idx_posts_author_time
  ON posts (author_user_id, created_at DESC) WHERE deleted_at IS NULL;

CREATE INDEX IF NOT EXISTS idx_posts_topics_gin
  ON posts USING GIN (topics);

CREATE TRIGGER trg_posts_updated_at
BEFORE UPDATE ON posts
FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-------------------------------------------------------
-- 2) comments：评论
-------------------------------------------------------
CREATE TABLE IF NOT EXISTS comments (
  id             UUID PRIMARY KEY,
  post_id        UUID NOT NULL REFERENCES posts(id) ON DELETE CASCADE,
  author_user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  text           TEXT NOT NULL,
  created_at     TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at     TIMESTAMPTZ NOT NULL DEFAULT now(),
  deleted_at     TIMESTAMPTZ
);

CREATE INDEX IF NOT EXISTS idx_comments_post_time
  ON comments (post_id, created_at) WHERE deleted_at IS NULL;

CREATE TRIGGER trg_comments_updated_at
BEFORE UPDATE ON comments
FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-------------------------------------------------------
-- 3) reactions：点赞/表情（针对帖子或评论）
-------------------------------------------------------
DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'reaction_target') THEN
    CREATE TYPE reaction_target AS ENUM ('post','comment');
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'reaction_type') THEN
    CREATE TYPE reaction_type   AS ENUM ('like'); -- 未来可扩到 love, haha, etc.
  END IF;
END$$;

CREATE TABLE IF NOT EXISTS reactions (
  id          UUID PRIMARY KEY,
  target_kind reaction_target NOT NULL,
  target_id   UUID            NOT NULL, -- 指向 posts.id 或 comments.id（应用层校验）
  user_id     UUID            NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  type        reaction_type   NOT NULL DEFAULT 'like',
  created_at  TIMESTAMPTZ     NOT NULL DEFAULT now(),
  CONSTRAINT uq_reaction UNIQUE (target_kind, target_id, user_id, type) -- 去重
);

CREATE INDEX IF NOT EXISTS idx_reactions_target
  ON reactions (target_kind, target_id);

CREATE INDEX IF NOT EXISTS idx_reactions_user
  ON reactions (user_id, created_at DESC);

-------------------------------------------------------
-- 4) bookmarks：收藏（用户-帖子 多对多）
-------------------------------------------------------
CREATE TABLE IF NOT EXISTS bookmarks (
  user_id    UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  post_id    UUID NOT NULL REFERENCES posts(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  PRIMARY KEY (user_id, post_id)
);

CREATE INDEX IF NOT EXISTS idx_bookmarks_user ON bookmarks (user_id, created_at DESC);

-------------------------------------------------------
-- 5) content_reports：内容举报
-------------------------------------------------------
DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'report_target') THEN
    CREATE TYPE report_target AS ENUM ('post','comment','user');
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'report_status') THEN
    CREATE TYPE report_status AS ENUM ('open','closed');
  END IF;
END$$;

CREATE TABLE IF NOT EXISTS content_reports (
  id               UUID PRIMARY KEY,
  reporter_user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  target_kind      report_target NOT NULL,
  target_id        UUID NOT NULL,
  reason           TEXT,
  status           report_status NOT NULL DEFAULT 'open',
  created_at       TIMESTAMPTZ   NOT NULL DEFAULT now(),
  closed_at        TIMESTAMPTZ
);

CREATE INDEX IF NOT EXISTS idx_reports_target ON content_reports (target_kind, target_id);
CREATE INDEX IF NOT EXISTS idx_reports_status ON content_reports (status);

-------------------------------------------------------
-- 6) notifications：通知中心（系统/互动）
-------------------------------------------------------
DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'notification_type') THEN
    CREATE TYPE notification_type AS ENUM ('comment','like','follow','system','reminder');
  END IF;
END$$;

CREATE TABLE IF NOT EXISTS notifications (
  id        UUID PRIMARY KEY,
  user_id   UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  type      notification_type NOT NULL,
  payload   JSONB NOT NULL DEFAULT '{}'::jsonb, -- {post_id, comment_id, actor_id,...}
  is_read   BOOLEAN NOT NULL DEFAULT FALSE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_notifications_inbox
  ON notifications (user_id, is_read, created_at DESC);

-------------------------------------------------------
-- 7) 话题字典与映射（可选；与 posts.topics 并存）
-------------------------------------------------------
CREATE TABLE IF NOT EXISTS topics (
  id           UUID PRIMARY KEY,
  slug         CITEXT UNIQUE,                  -- 规范化标识
  display_name TEXT NOT NULL,
  meta         JSONB NOT NULL DEFAULT '{}'::jsonb,
  created_at   TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE IF NOT EXISTS post_topics (
  post_id  UUID NOT NULL REFERENCES posts(id) ON DELETE CASCADE,
  topic_id UUID NOT NULL REFERENCES topics(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  PRIMARY KEY (post_id, topic_id)
);

CREATE INDEX IF NOT EXISTS idx_post_topics_topic ON post_topics (topic_id);

```

### 说明要点

- **时间线检索**：`posts(author_user_id, created_at DESC)`、`comments(post_id, created_at)` 覆盖作者页与帖子详情分页。
- **软删除**：`posts/comments.deleted_at` + 局部索引过滤，支持回收站/合规。
- **话题两制并行**：启动期可仅用 `posts.topics[]`；规模增大后可逐步沉淀到 `topics + post_topics`，便于聚合与纠错。
- **互动去重**：`reactions` 以 `(target_kind, target_id, user_id, type)` 唯一约束防止重复点赞。
- **通知**：`notifications` 设计为**不可变事件**（append-only），前台按 `user_id/is_read` 拉取。
- **扩展位**：`media/payload/meta` 采用 JSONB，减少早期迁移压力；命中查询键可加表达式/GIN 索引。