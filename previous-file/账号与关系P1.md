# 账号与关系 P1.0

## 目标

承载**账户体系与社交关系**（用户、资料、关注、拉黑）并新增**用户待办**（可选关联宠物，但本质是用户域的生产力功能）。保持字段规范化、软删除友好、预留扩展位。

## 表与关系

- **users**（用户主表）1 — 1 **user_profiles**
- **users**（follower/followee）n — n **user_follows**
- **users**（blocker/blocked）n — n **user_blocks**
- **users** 1 — n **user_todos**（待办；`pet_id` 可空，仅在需要时关联宠物）

---

## PostgreSQL DDL（可直接执行）

```sql
-- 扩展：邮箱大小写不敏感
CREATE EXTENSION IF NOT EXISTS citext;

-- 通用触发器：自动更新时间戳
CREATE OR REPLACE FUNCTION set_updated_at()
RETURNS TRIGGER AS $$
BEGIN NEW.updated_at = now(); RETURN NEW; END;
$$ LANGUAGE plpgsql;

-- 1) users：用户主表
CREATE TABLE IF NOT EXISTS users (
  id            UUID PRIMARY KEY,
  email         CITEXT UNIQUE,
  password_hash TEXT,                     -- 三方登录可为空
  nickname      TEXT,
  avatar_url    TEXT,
  settings      JSONB        NOT NULL DEFAULT '{}'::jsonb,  -- 通知偏好、语言等
  created_at    TIMESTAMPTZ  NOT NULL DEFAULT now(),
  updated_at    TIMESTAMPTZ  NOT NULL DEFAULT now(),
  deleted_at    TIMESTAMPTZ
);
CREATE INDEX IF NOT EXISTS idx_users_active ON users ((email)) WHERE deleted_at IS NULL;

CREATE TRIGGER trg_users_updated_at
BEFORE UPDATE ON users
FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- 2) user_profiles：扩展资料（可与 users 分表解耦）
CREATE TABLE IF NOT EXISTS user_profiles (
  user_id     UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
  bio         TEXT,
  location    TEXT,
  links       JSONB NOT NULL DEFAULT '{}'::jsonb, -- 社媒/站点
  extra       JSONB NOT NULL DEFAULT '{}'::jsonb, -- 预留扩展
  updated_at  TIMESTAMPTZ NOT NULL DEFAULT now()
);
CREATE TRIGGER trg_user_profiles_updated_at
BEFORE UPDATE ON user_profiles
FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- 3) user_follows：关注关系（去重 + 禁止自关注）
CREATE TABLE IF NOT EXISTS user_follows (
  follower_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  followee_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  created_at  TIMESTAMPTZ NOT NULL DEFAULT now(),
  PRIMARY KEY (follower_id, followee_id),
  CONSTRAINT chk_follow_self CHECK (follower_id <> followee_id)
);
CREATE INDEX IF NOT EXISTS idx_user_follows_follower ON user_follows (follower_id);
CREATE INDEX IF NOT EXISTS idx_user_follows_followee ON user_follows (followee_id);

-- 4) user_blocks：拉黑关系（去重 + 禁止自拉黑）
CREATE TABLE IF NOT EXISTS user_blocks (
  blocker_id  UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  blocked_id  UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  created_at  TIMESTAMPTZ NOT NULL DEFAULT now(),
  PRIMARY KEY (blocker_id, blocked_id),
  CONSTRAINT chk_block_self CHECK (blocker_id <> blocked_id)
);
CREATE INDEX IF NOT EXISTS idx_user_blocks_blocker ON user_blocks (blocker_id);
CREATE INDEX IF NOT EXISTS idx_user_blocks_blocked ON user_blocks (blocked_id);

-- 5) user_todos：用户待办（精简版；可选关联宠物）
DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'todo_priority') THEN
    CREATE TYPE todo_priority AS ENUM ('low','medium','high');
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'todo_status') THEN
    CREATE TYPE todo_status AS ENUM ('todo','in_progress','done','cancelled');
  END IF;
END$$;

CREATE TABLE IF NOT EXISTS user_todos (
  id           UUID PRIMARY KEY,
  user_id      UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  pet_id       UUID REFERENCES pets(id) ON DELETE SET NULL,   -- 可空：用于与宠物无关的待办
  title        TEXT NOT NULL,
  description  TEXT,
  tags         TEXT[] NOT NULL DEFAULT '{}',                  -- 轻量标签（不拆表）
  priority     todo_priority NOT NULL DEFAULT 'medium',
  status       todo_status   NOT NULL DEFAULT 'todo',
  start_at     TIMESTAMPTZ,
  due_at       TIMESTAMPTZ,
  remind_at    TIMESTAMPTZ,                                   -- 需要提醒时才填
  meta         JSONB NOT NULL DEFAULT '{}'::jsonb,            -- 颜色/来源等扩展
  created_at   TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at   TIMESTAMPTZ NOT NULL DEFAULT now(),
  deleted_at   TIMESTAMPTZ
);

CREATE INDEX IF NOT EXISTS idx_user_todos_user_due
  ON user_todos (user_id, due_at NULLS LAST) WHERE deleted_at IS NULL;

CREATE INDEX IF NOT EXISTS idx_user_todos_user_status
  ON user_todos (user_id, status) WHERE deleted_at IS NULL;

CREATE INDEX IF NOT EXISTS idx_user_todos_pet
  ON user_todos (pet_id) WHERE deleted_at IS NULL;

CREATE INDEX IF NOT EXISTS idx_user_todos_tags_gin
  ON user_todos USING GIN (tags);

CREATE TRIGGER trg_user_todos_updated_at
BEFORE UPDATE ON user_todos
FOR EACH ROW EXECUTE FUNCTION set_updated_at();

```

### 说明要点

- **职责边界**：`user_todos` 属于**账号域**；与宠物无关的待办也能自然承载；`pet_id` 仅在需要时挂接。
- **软删除与扩展**：所有表预留 `deleted_at` 与 `JSONB` 扩展位，减少未来迁移。
- **索引**：覆盖用户维度的**状态/截止时间**查询，以及按 `pet_id` 的筛选与标签检索。
- **与日历聚合**：保持 `reminders` 在宠物域不变；通过只读视图（如 `calendar_items_v`）在查询层合并 `reminders + user_todos`，而非在存储层耦合。