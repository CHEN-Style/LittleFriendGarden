# 宠物主数据与素材池 P2（改进版）

## 0. 准备

```sql
CREATE EXTENSION IF NOT EXISTS pgcrypto;

```

### 通用更新时间触发器

```sql
CREATE OR REPLACE FUNCTION set_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at := now();
  RETURN NEW;
END
$$ LANGUAGE plpgsql;

```

> 约定：支持软删除的表统一包含 deleted_at TIMESTAMPTZ NULL，查询默认过滤 deleted_at IS NULL，并为主要路径建立部分索引。
> 

---

## 1. 宠物主数据

### 1.1 宠物主表

```sql
CREATE TABLE IF NOT EXISTS pets (
  id                 UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name               TEXT NOT NULL,
  species            TEXT NOT NULL,         -- 'cat'|'dog'|'rabbit'|...（用 CHECK 控约束）
  breed              TEXT,                  -- 纯文本或对照表（见 1.2）
  sex                TEXT,                  -- 'male'|'female'|'unknown'
  birth_date         DATE,
  color              TEXT,
  avatar_asset_id    UUID,                  -- 指向素材池封面（可选）
  primary_owner_id   UUID NOT NULL,         -- 主人（必须在 pet_owners 中存在，触发器保证）
  settings           JSONB NOT NULL DEFAULT '{}'::jsonb,  -- 个性化设置（隐私、共享策略等）
  created_at         TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at         TIMESTAMPTZ NOT NULL DEFAULT now(),
  deleted_at         TIMESTAMPTZ,
  CHECK (species IN ('cat','dog','bird','rabbit','reptile','fish','other')),
  CHECK (sex IN ('male','female','unknown'))
);

CREATE TRIGGER trg_pets_updated_at
BEFORE UPDATE ON pets
FOR EACH ROW EXECUTE FUNCTION set_updated_at();

```

> avatar_asset_id 仅作为“封面”引用；实际图片/视频请入 pet_assets。你也可以选择不设置该列，改为在视图中动态选取最新或已标注为“封面”的资产。
> 

### 1.2 品种字典（可选）

```sql
CREATE TABLE IF NOT EXISTS pet_breeds (
  id           UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  species      TEXT NOT NULL,
  breed_name   TEXT NOT NULL,
  aka          TEXT[],                       -- 别名
  created_at   TIMESTAMPTZ NOT NULL DEFAULT now(),
  UNIQUE (species, breed_name)
);

-- 若要将 pets.breed 与此字典绑定，可新增外键列 pets.breed_id 代替纯文本：
-- ALTER TABLE pets ADD COLUMN breed_id UUID REFERENCES pet_breeds(id);

```

### 1.3 宠物-用户关系（多成员共享）

```sql
CREATE TABLE IF NOT EXISTS pet_owners (
  pet_id        UUID NOT NULL REFERENCES pets(id) ON DELETE CASCADE,
  user_id       UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  role          TEXT NOT NULL DEFAULT 'owner',  -- 'owner'|'family'|'viewer'
  note          TEXT,
  created_at    TIMESTAMPTZ NOT NULL DEFAULT now(),
  PRIMARY KEY (pet_id, user_id),
  CHECK (role IN ('owner','family','viewer'))
);

CREATE INDEX IF NOT EXISTS idx_pet_owners_user ON pet_owners (user_id);

```

### 主人一致性触发器（关键改进）

> 确保 pets.primary_owner_id 始终也存在于 pet_owners(pet_id, user_id)。
> 

```sql
CREATE OR REPLACE FUNCTION ensure_primary_owner_in_pet_owners()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.primary_owner_id IS NOT NULL THEN
    INSERT INTO pet_owners (pet_id, user_id, role)
    VALUES (NEW.id, NEW.primary_owner_id, 'owner')
    ON CONFLICT (pet_id, user_id) DO NOTHING;
  END IF;
  RETURN NEW;
END
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS trg_pets_primary_owner_consistency ON pets;
CREATE TRIGGER trg_pets_primary_owner_consistency
AFTER INSERT OR UPDATE OF primary_owner_id ON pets
FOR EACH ROW EXECUTE FUNCTION ensure_primary_owner_in_pet_owners();

```

---

## 2. 素材池（图片/视频等文件的元数据）

> 关键修复：uploader_user_id 采用 可空列 + ON DELETE SET NULL，这样删除用户不会导致资产删除或外键冲突。
> 
> 
> **推荐**：资产与宠物既可无绑定（用户临时上传），也可绑定 `pet_id`；通过 `visibility` 与审核字段促进合规。
> 

```sql
CREATE TABLE IF NOT EXISTS pet_assets (
  id                UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  pet_id            UUID,                                      -- 可选：资产归属的宠物
  uploader_user_id  UUID,                                      -- 可选：上传者（删除用户后置空）
  title             TEXT,
  description       TEXT,
  storage_url       TEXT NOT NULL,                             -- 实际存储地址（S3/OSS/CDN）
  storage_provider  TEXT NOT NULL DEFAULT 's3',                -- 's3'|'oss'|'gcs'|...
  mime_type         TEXT,                                      -- 'image/jpeg','video/mp4',...
  byte_size         BIGINT,                                    -- 文件大小
  pixel_width       INTEGER,
  pixel_height      INTEGER,
  duration_seconds  NUMERIC(10,3),                             -- 视频/音频时长
  content_hash      TEXT,                                      -- SHA256/MD5 等
  tags              TEXT[] NOT NULL DEFAULT ARRAY[]::TEXT[],   -- 轻量标签（搜索/分组）
  visibility        TEXT NOT NULL DEFAULT 'private',           -- 'public'|'shared'|'private'
  moderation_status TEXT NOT NULL DEFAULT 'pending',           -- 'pending'|'approved'|'rejected'
  meta              JSONB NOT NULL DEFAULT '{}'::jsonb,        -- 其他可扩展元信息（EXIF、机型、镜头等）
  created_at        TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at        TIMESTAMPTZ NOT NULL DEFAULT now(),
  deleted_at        TIMESTAMPTZ,
  CHECK (visibility IN ('public','shared','private')),
  CHECK (moderation_status IN ('pending','approved','rejected'))
);

-- 外键（延后添加以避免初始化时跨域失败）
ALTER TABLE pet_assets
  ADD CONSTRAINT fk_pet_assets_pet
  FOREIGN KEY (pet_id) REFERENCES pets(id) ON DELETE SET NULL;

ALTER TABLE pet_assets
  ADD CONSTRAINT fk_pet_assets_uploader
  FOREIGN KEY (uploader_user_id) REFERENCES users(id) ON DELETE SET NULL;

CREATE TRIGGER trg_pet_assets_updated_at
BEFORE UPDATE ON pet_assets
FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- 常用索引
CREATE INDEX IF NOT EXISTS idx_pet_assets_pet_alive
  ON pet_assets (pet_id, created_at DESC) WHERE deleted_at IS NULL;

CREATE INDEX IF NOT EXISTS idx_pet_assets_uploader_alive
  ON pet_assets (uploader_user_id, created_at DESC) WHERE deleted_at IS NULL;

CREATE INDEX IF NOT EXISTS idx_pet_assets_tags_gin
  ON pet_assets USING GIN (tags);

-- 表达式索引（搜索）
CREATE INDEX IF NOT EXISTS idx_pet_assets_content_hash
  ON pet_assets (content_hash);

CREATE INDEX IF NOT EXISTS idx_pet_assets_mime
  ON pet_assets (mime_type);

-- 视图：为每只宠物选取“封面”（优先选择标记在 meta->>'isCover' = 'true'，否则按最新一张图片）
CREATE OR REPLACE VIEW pet_cover_asset_v AS
WITH ranked AS (
  SELECT
    a.*,
    (a.meta->>'isCover') = 'true' AS is_cover_mark,
    ROW_NUMBER() OVER (
      PARTITION BY a.pet_id
      ORDER BY
        ((a.meta->>'isCover') = 'true') DESC,
        (CASE WHEN a.mime_type ILIKE 'image/%' THEN 1 ELSE 2 END),
        a.created_at DESC
    ) AS rn
  FROM pet_assets a
  WHERE a.deleted_at IS NULL
)
SELECT * FROM ranked WHERE rn = 1;

```

> 如要把 pets.avatar_asset_id 与此视图联动，可以在应用层：优先读视图封面，其次回退 pets.avatar_asset_id；或写触发器在“标记封面/新增首图”时同步更新主表。
> 

---

## 3. 共享与可见性（示例）

> 以下仅为数据层面的最小约束；真正的访问控制建议结合 RLS（行级安全） 与“账号与关系”域的 user_blocks/user_follows，在后端设置 app.current_user_id 后由策略函数判定。
> 

```sql
-- 示例：如果后续要对 pet_assets 开启 RLS（可选）
-- ALTER TABLE pet_assets ENABLE ROW LEVEL SECURITY;

-- CREATE OR REPLACE FUNCTION current_user_id() RETURNS UUID AS $$
--   SELECT current_setting('app.current_user_id', true)::uuid
-- $$ LANGUAGE sql STABLE;

-- CREATE POLICY pet_assets_public
--   ON pet_assets FOR SELECT
--   USING (visibility = 'public' AND deleted_at IS NULL);

-- 更多策略可结合 pet_owners（拥有者/共享者）与 blocks（屏蔽）判定。

```

---

## 4. 兼容与迁移建议

1. **修复历史外键冲突**
- 若旧表 `pet_assets.uploader_user_id` 为 `NOT NULL` + `ON DELETE SET NULL`，先执行：
    
    ```sql
    ALTER TABLE pet_assets ALTER COLUMN uploader_user_id DROP NOT NULL;
    -- 若外键约束名不一致，需先 DROP 再 ADD，本文已用 ADD CONSTRAINT 标准名。
    
    ```
    
- 清理历史“孤儿引用”（如不存在的 `users.id`）：
    
    ```sql
    UPDATE pet_assets a
    SET uploader_user_id = NULL
    WHERE NOT EXISTS (SELECT 1 FROM users u WHERE u.id = a.uploader_user_id);
    
    ```
    
1. **主人的一致性**
- 如果已有大量 `pets` 数据但 `pet_owners` 不全，先一次性补齐：
    
    ```sql
    INSERT INTO pet_owners (pet_id, user_id, role)
    SELECT p.id, p.primary_owner_id, 'owner'
    FROM pets p
    LEFT JOIN pet_owners o
      ON o.pet_id = p.id AND o.user_id = p.primary_owner_id
    WHERE o.pet_id IS NULL;
    
    ```
    
1. **素材封面**
- 如决定不在 `pets` 存 `avatar_asset_id`，可移除该列并统一通过 `pet_cover_asset_v` 提供封面；反之保留该列可在“标记封面”时同步更新，提高读取效率。

---

## 5. 最小自检（可直接跑）

```sql
-- 1) 新建一只宠物
WITH u AS (
  SELECT id AS owner_id FROM users ORDER BY created_at LIMIT 1
)
INSERT INTO pets (name, species, sex, primary_owner_id, settings)
SELECT '奶茶', 'cat', 'female', owner_id, '{"share":"family"}'
FROM u
RETURNING id INTO TEMP TABLE _p(pet_id);

-- 2) 自动补齐主人关系触发器应生效
SELECT * FROM pet_owners WHERE pet_id IN (SELECT pet_id FROM _p);

-- 3) 上传一张图片资产（未绑定上传者也允许）
INSERT INTO pet_assets (pet_id, title, storage_url, mime_type, byte_size, tags, meta)
SELECT pet_id, '第一次洗澡', 'https://cdn.example.com/asset1.jpg', 'image/jpeg', 2456789,
       ARRAY['bath','cute'], '{"isCover":"true"}'
FROM _p;

-- 4) 查看封面视图
SELECT * FROM pet_cover_asset_v WHERE pet_id IN (SELECT pet_id FROM _p);

```