# 宠物记录（健康 / 喂养 / 体重等）P2（改进版）

## 0. 准备

```sql
CREATE EXTENSION IF NOT EXISTS pgcrypto;

```

统一的更新时间触发器（若上域已创建同名函数，可重复执行）：

```sql
CREATE OR REPLACE FUNCTION set_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at := now();
  RETURN NEW;
END
$$ LANGUAGE plpgsql;

```

> 约定：支持软删除的表统一包含 deleted_at TIMESTAMPTZ NULL，查询默认过滤 deleted_at IS NULL，并为主要路径建立部分索引。
> 

---

## 1) 体重记录 `pet_weights`

```sql
CREATE TABLE IF NOT EXISTS pet_weights (
  id             UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  pet_id         UUID NOT NULL REFERENCES pets(id) ON DELETE CASCADE,
  measured_at    TIMESTAMPTZ NOT NULL,                -- 测量时间
  weight_kg      NUMERIC(6,3)  NOT NULL,              -- 支持到克位
  source         TEXT NOT NULL DEFAULT 'manual',      -- 'manual'|'scale' 等
  note           TEXT,
  created_at     TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at     TIMESTAMPTZ NOT NULL DEFAULT now(),
  deleted_at     TIMESTAMPTZ,
  CONSTRAINT chk_weight_positive CHECK (weight_kg > 0),
  CONSTRAINT uq_pet_weight_time UNIQUE (pet_id, measured_at)
);

CREATE TRIGGER trg_pet_weights_updated_at
BEFORE UPDATE ON pet_weights
FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- 常用索引：按时间线读取最新、区间查询
CREATE INDEX IF NOT EXISTS idx_pet_weights_pet_time_alive
  ON pet_weights (pet_id, measured_at DESC)
  WHERE deleted_at IS NULL;

-- 最新体重视图
CREATE OR REPLACE VIEW pet_latest_weight_v AS
SELECT DISTINCT ON (pet_id)
  pet_id, id AS weight_id, measured_at, weight_kg, source, note, created_at
FROM pet_weights
WHERE deleted_at IS NULL
ORDER BY pet_id, measured_at DESC;

```

---

## 2) 喂养记录 `pet_feedings`

```sql
CREATE TABLE IF NOT EXISTS pet_feedings (
  id               UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  pet_id           UUID NOT NULL REFERENCES pets(id) ON DELETE CASCADE,
  user_id          UUID REFERENCES users(id) ON DELETE SET NULL,  -- 记录者可空
  fed_at           TIMESTAMPTZ NOT NULL,                          -- 喂食时间
  food_name        TEXT,                                          -- 例：主粮名
  brand            TEXT,
  amount_g         NUMERIC(8,3),                                  -- 克
  moisture_pct     NUMERIC(5,2),                                  -- 含水率%
  calories_kcal    NUMERIC(10,3),                                 -- 千卡
  method           TEXT NOT NULL DEFAULT 'manual',                -- 'manual'|'auto_feeder'
  note             TEXT,
  created_at       TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at       TIMESTAMPTZ NOT NULL DEFAULT now(),
  deleted_at       TIMESTAMPTZ,
  CONSTRAINT chk_amount_nonneg   CHECK (amount_g      IS NULL OR amount_g      >= 0),
  CONSTRAINT chk_moisture_range  CHECK (moisture_pct  IS NULL OR (moisture_pct >= 0 AND moisture_pct <= 100)),
  CONSTRAINT chk_calorie_nonneg  CHECK (calories_kcal IS NULL OR calories_kcal >= 0)
);

CREATE TRIGGER trg_pet_feedings_updated_at
BEFORE UPDATE ON pet_feedings
FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- 常用索引：时间线/用户维度
CREATE INDEX IF NOT EXISTS idx_pet_feedings_pet_time_alive
  ON pet_feedings (pet_id, fed_at DESC) WHERE deleted_at IS NULL;

CREATE INDEX IF NOT EXISTS idx_pet_feedings_user_time_alive
  ON pet_feedings (user_id, fed_at DESC) WHERE deleted_at IS NULL;

-- 日汇总（克/千卡）
CREATE OR REPLACE VIEW pet_daily_feed_summary_v AS
SELECT
  pet_id,
  date_trunc('day', fed_at AT TIME ZONE 'UTC')::date AS d_utc,
  COUNT(*)                        AS feed_count,
  SUM(COALESCE(amount_g, 0))     AS total_amount_g,
  SUM(COALESCE(calories_kcal,0)) AS total_kcal
FROM pet_feedings
WHERE deleted_at IS NULL
GROUP BY pet_id, date_trunc('day', fed_at AT TIME ZONE 'UTC')::date;

```

> 如需本地化到用户时区，可在后端或视图参数化处理（例如利用 current_setting('app.tz')）构造本地日界。
> 

---

## 3) 医疗类记录（疫苗 / 驱虫 / 体检 / 手术 / 用药 / 过敏）

使用一张通用“医疗记录”表 + 轻量类型约束；可扩展 `details` 存放结构化字段（批号、剂量、部位等）。如需附件，使用附件关系表关联 `pet_assets`。

```sql
CREATE TABLE IF NOT EXISTS pet_medical_records (
  id               UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  pet_id           UUID NOT NULL REFERENCES pets(id) ON DELETE CASCADE,
  kind             TEXT NOT NULL,                       -- 'vaccine'|'deworm'|'exam'|'surgery'|'medication'|'allergy'|'other'
  title            TEXT,                                -- 例：疫苗名称/项目名称
  details          JSONB NOT NULL DEFAULT '{}'::jsonb,  -- 例：{"dose":"1ml","batch":"X123","site":"left leg"}
  clinic           TEXT,                                -- 机构
  veterinarian     TEXT,                                -- 医生
  status           TEXT NOT NULL DEFAULT 'done',        -- 'planned'|'done'|'cancelled'
  due_at           TIMESTAMPTZ,                         -- 计划日期（如“下次疫苗”）
  performed_at     TIMESTAMPTZ,                         -- 实施日期
  note             TEXT,
  created_at       TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at       TIMESTAMPTZ NOT NULL DEFAULT now(),
  deleted_at       TIMESTAMPTZ,
  CHECK (kind   IN ('vaccine','deworm','exam','surgery','medication','allergy','other')),
  CHECK (status IN ('planned','done','cancelled'))
);

CREATE TRIGGER trg_pet_medical_records_updated_at
BEFORE UPDATE ON pet_medical_records
FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- 常用索引：按状态/时间检索即将到期或最近完成
CREATE INDEX IF NOT EXISTS idx_pet_medical_due_alive
  ON pet_medical_records (pet_id, status, due_at)
  WHERE deleted_at IS NULL;

CREATE INDEX IF NOT EXISTS idx_pet_medical_done_alive
  ON pet_medical_records (pet_id, performed_at DESC)
  WHERE deleted_at IS NULL;

-- 附件（可选）
CREATE TABLE IF NOT EXISTS pet_medical_attachments (
  record_id   UUID NOT NULL REFERENCES pet_medical_records(id) ON DELETE CASCADE,
  asset_id    UUID NOT NULL REFERENCES pet_assets(id) ON DELETE CASCADE,
  created_at  TIMESTAMPTZ NOT NULL DEFAULT now(),
  PRIMARY KEY (record_id, asset_id)
);

```

> 你可以在应用层为常见的“疫苗计划/驱虫周期”建立模板，然后落地到 pet_medical_records(status='planned', due_at=...)，结合提醒模块触发提醒。
> 

---

## 4) 统一提醒 `reminders`（与账号域对齐）

> 若你的 reminders 先前已存在，这里给出幂等创建与补丁。与账号域 user_todos 一致采用 TEXT + CHECK + 软删除，并保留 calendar_items_v 的消费字段。
> 

```sql
-- 表（如存在将跳过）
CREATE TABLE IF NOT EXISTS reminders (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id         UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  pet_id          UUID,  -- 可选
  title           TEXT NOT NULL,
  description     TEXT,
  priority        TEXT NOT NULL DEFAULT 'medium',  -- 'low'|'medium'|'high'|'urgent'
  status          TEXT NOT NULL DEFAULT 'pending', -- 'pending'|'done'|'archived'
  scheduled_at    TIMESTAMPTZ,                     -- 计划触发时间
  due_at          TIMESTAMPTZ,                     -- 截止时间（可选）
  snooze_until    TIMESTAMPTZ,                     -- 贪睡到
  repeat_rule     TEXT,                             -- iCal RRULE 可选：例如 FREQ=MONTHLY;INTERVAL=1
  timezone        TEXT,                             -- 例如 'Asia/Tokyo'
  created_at      TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at      TIMESTAMPTZ NOT NULL DEFAULT now(),
  deleted_at      TIMESTAMPTZ,
  CONSTRAINT chk_rem_priority CHECK (priority IN ('low','medium','high','urgent')),
  CONSTRAINT chk_rem_status   CHECK (status   IN ('pending','done','archived'))
);

-- 外键（延后添加以避免跨域失败）
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_constraint
    WHERE conname = 'fk_reminders_pet'
  ) THEN
    ALTER TABLE reminders
      ADD CONSTRAINT fk_reminders_pet
      FOREIGN KEY (pet_id) REFERENCES pets(id) ON DELETE SET NULL;
  END IF;
END$$;

-- 触发器与索引
DROP TRIGGER IF EXISTS trg_reminders_updated_at ON reminders;
CREATE TRIGGER trg_reminders_updated_at
BEFORE UPDATE ON reminders
FOR EACH ROW EXECUTE FUNCTION set_updated_at();

CREATE INDEX IF NOT EXISTS idx_reminders_user_time_alive
  ON reminders (user_id, scheduled_at)
  WHERE deleted_at IS NULL;

-- 若旧表缺少 deleted_at，可执行：
-- ALTER TABLE reminders ADD COLUMN IF NOT EXISTS deleted_at TIMESTAMPTZ;

```

> 账号域已提供 calendar_items_v 统一聚合视图；此处 schema 与字段命名已对齐，无需额外改动即可并入。
> 

---

## 5) 通用事件时间线 `pet_events`（可选，支持分区）

> 用于统一承载“宠物相关事件”，既可作为通用日志，也可连接专表。
> 
> 
> 为避免“多态外键不可验证”的硬伤，这里采用**“弱绑定多列 + CHECK”**：仅允许**恰好一种**引用被填写（如 weight/feeding/medical 三选一），数据库层强制一致性。
> 同时给出**按月分区**方案（可只启用父表，不分区也可）。
> 

```sql
-- 父表（按发生时间分区）
CREATE TABLE IF NOT EXISTS pet_events (
  id             UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  pet_id         UUID NOT NULL REFERENCES pets(id) ON DELETE CASCADE,
  event_type     TEXT NOT NULL,                             -- 'weight'|'feeding'|'vaccination'|'deworm'|'vet_visit'|'bath'|'groom'|'walk'|'medication'|'note'|'other'
  occurred_at    TIMESTAMPTZ NOT NULL,
  -- “弱绑定”引用：三者恰有其一
  weight_id      UUID REFERENCES pet_weights(id)           ON DELETE CASCADE,
  feeding_id     UUID REFERENCES pet_feedings(id)          ON DELETE CASCADE,
  medical_id     UUID REFERENCES pet_medical_records(id)   ON DELETE CASCADE,
  payload        JSONB NOT NULL DEFAULT '{}'::jsonb,       -- 额外上下文（如地理、设备、症状）
  created_at     TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at     TIMESTAMPTZ NOT NULL DEFAULT now(),
  deleted_at     TIMESTAMPTZ,
  CHECK (event_type IN ('weight','feeding','vaccination','deworm','vet_visit','bath','groom','walk','medication','note','other')),
  CHECK (
    (weight_id  IS NOT NULL)::int +
    (feeding_id IS NOT NULL)::int +
    (medical_id IS NOT NULL)::int
    IN (0,1)  -- 允许无绑定（纯日志），或仅一种绑定
  )
) PARTITION BY RANGE (occurred_at);

CREATE TRIGGER trg_pet_events_updated_at
BEFORE UPDATE ON pet_events
FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- 父表通用索引（建议在各分区上也建立同名索引）
CREATE INDEX IF NOT EXISTS idx_pet_events_pet_time_alive
  ON pet_events (pet_id, occurred_at DESC)
  WHERE deleted_at IS NULL;

-- 简易：预建最近三个月分区（可按需扩展）
DO $$
DECLARE
  start_month DATE := date_trunc('month', now())::date - INTERVAL '1 month';
  m DATE;
  p_name TEXT;
  from_ts TIMESTAMPTZ;
  to_ts   TIMESTAMPTZ;
BEGIN
  FOR m IN 0..2 LOOP
    from_ts := (start_month + (m || ' month')::interval);
    to_ts   := (start_month + ((m+1) || ' month')::interval);
    p_name  := 'pet_events_' || to_char(from_ts, 'YYYYMM');
    EXECUTE format($f$
      CREATE TABLE IF NOT EXISTS %I PARTITION OF pet_events
      FOR VALUES FROM (%L) TO (%L);
      CREATE INDEX IF NOT EXISTS %I ON %I (pet_id, occurred_at DESC) WHERE deleted_at IS NULL;
    $f$, p_name, from_ts, to_ts, 'idx_'||p_name||'_pet_time_alive', p_name);
  END LOOP;
END$$;

```

> 如果暂不需要分区，可改为普通表（去掉 PARTITION BY 与分区块），其余字段保持不变。
> 

---

## 6) 统一健康时间线视图（便于前端直接消费）

> 两种选择：
> 
> 
> A) 如果你启用了 `pet_events` 并在写入专表时同步插入事件，直接基于 `pet_events` 做视图即可。
> 
> B) 若暂未使用 `pet_events`，用 `UNION ALL` 汇总专表流。
> 

**A. 基于 `pet_events` 的时间线（推荐）：**

```sql
CREATE OR REPLACE VIEW pet_health_timeline_v AS
SELECT
  e.pet_id,
  e.id           AS event_id,
  e.event_type,
  e.occurred_at,
  e.weight_id,
  e.feeding_id,
  e.medical_id,
  e.payload,
  e.created_at
FROM pet_events e
WHERE e.deleted_at IS NULL;

```

**B. 直接汇总专表（备选）：**

```sql
CREATE OR REPLACE VIEW pet_health_timeline_v AS
SELECT
  w.pet_id,
  w.id         AS event_id,
  'weight'     AS event_type,
  w.measured_at AS occurred_at,
  w.id         AS weight_id,
  NULL::uuid   AS feeding_id,
  NULL::uuid   AS medical_id,
  jsonb_build_object('weight_kg', w.weight_kg, 'source', w.source, 'note', w.note) AS payload,
  w.created_at
FROM pet_weights w
WHERE w.deleted_at IS NULL

UNION ALL
SELECT
  f.pet_id,
  f.id,
  'feeding',
  f.fed_at,
  NULL, f.id, NULL,
  jsonb_build_object('food', f.food_name, 'brand', f.brand, 'amount_g', f.amount_g, 'kcal', f.calories_kcal, 'method', f.method, 'note', f.note),
  f.created_at
FROM pet_feedings f
WHERE f.deleted_at IS NULL

UNION ALL
SELECT
  m.pet_id,
  m.id,
  CASE
    WHEN m.kind='vaccine'   THEN 'vaccination'
    WHEN m.kind='deworm'    THEN 'deworm'
    WHEN m.kind='medication'THEN 'medication'
    WHEN m.kind='exam'      THEN 'vet_visit'
    ELSE 'note'
  END AS event_type,
  COALESCE(m.performed_at, m.due_at, m.created_at) AS occurred_at,
  NULL, NULL, m.id,
  jsonb_build_object('kind', m.kind, 'status', m.status, 'title', m.title, 'clinic', m.clinic, 'vet', m.veterinarian, 'details', m.details, 'note', m.note),
  m.created_at
FROM pet_medical_records m
WHERE m.deleted_at IS NULL;

```

---

## 7) RLS（行级安全）示例（可按需启用）

> 结合宠物域的 pet_owners 与账号域的 user_blocks，可将访问控制下沉到数据库。下例仅给出方向，启用前需在会话设置 SET app.current_user_id = '<uuid>' 并实现 is_pet_visible_to_user()（上一域已放置占位函数）。
> 

```sql
-- 仅示意：对 pet_weights 开启只对可见宠物记录可读
-- ALTER TABLE pet_weights ENABLE ROW LEVEL SECURITY;
-- CREATE POLICY pet_weights_visible
--   ON pet_weights FOR SELECT
--   USING (is_pet_visible_to_user(current_setting('app.current_user_id', true)::uuid, pet_id) = TRUE
--          AND deleted_at IS NULL);

```

---

## 8) 迁移与数据修复建议

1. **为既有 `reminders` 补齐软删除**
    
    ```sql
    ALTER TABLE reminders ADD COLUMN IF NOT EXISTS deleted_at TIMESTAMPTZ;
    
    ```
    
2. **历史数据质量检查**
    - 体重：`weight_kg <= 0` 置为 NULL 或人工复核；
    - 喂养：`amount_g < 0`、`moisture_pct` 超界、`calories_kcal < 0` 修正；
    - 医疗：`status` 不在三种之一的统一改为 `'done'` 或 `'other'` 并记录备注。
3. **事件同步（若启用 `pet_events`）**
    - 写入专表时，同时插入 `pet_events`，保证时间线统一可查；
    - 为既有数据批量回填 `pet_events`：按专表构造 `INSERT … SELECT`。

---

## 9) 最小自检（可直接运行）

```sql
-- 前置：挑一只宠物
WITH p AS (
  SELECT id AS pet_id FROM pets WHERE deleted_at IS NULL ORDER BY created_at LIMIT 1
)
-- 1) 记录体重
INSERT INTO pet_weights (pet_id, measured_at, weight_kg, source, note)
SELECT pet_id, now() - interval '1 day', 4.250, 'manual', 'home scale' FROM p;

-- 2) 记录喂养
INSERT INTO pet_feedings (pet_id, fed_at, food_name, amount_g, calories_kcal, method, note)
SELECT pet_id, now() - interval '12 hour', 'main kibble', 50, 180, 'manual', 'half bowl' FROM p;

-- 3) 记录疫苗（完成）
INSERT INTO pet_medical_records (pet_id, kind, title, status, performed_at, details)
SELECT pet_id, 'vaccine', 'Rabies', 'done', now() - interval '5 day', '{"dose":"1ml","batch":"RB-2025"}'::jsonb FROM p;

-- 4) 计划下次驱虫（提醒用）
INSERT INTO pet_medical_records (pet_id, kind, title, status, due_at)
SELECT pet_id, 'deworm', 'Deworm - quarterly', 'planned', now() + interval '85 day' FROM p;

-- 5) 如启用 pet_events：为上面三条回填事件
INSERT INTO pet_events (pet_id, event_type, occurred_at, weight_id)
SELECT w.pet_id, 'weight', w.measured_at, w.id FROM pet_weights w
ORDER BY w.created_at DESC LIMIT 1;

INSERT INTO pet_events (pet_id, event_type, occurred_at, feeding_id)
SELECT f.pet_id, 'feeding', f.fed_at, f.id FROM pet_feedings f
ORDER BY f.created_at DESC LIMIT 1;

INSERT INTO pet_events (pet_id, event_type, occurred_at, medical_id)
SELECT m.pet_id,
       CASE WHEN m.kind='vaccine' THEN 'vaccination'
            WHEN m.kind='deworm'  THEN 'deworm'
            WHEN m.kind='medication' THEN 'medication'
            ELSE 'vet_visit' END,
       COALESCE(m.performed_at, m.due_at, now()),
       m.id
FROM pet_medical_records m
ORDER BY m.created_at DESC LIMIT 1;

-- 6) 检查视图
SELECT * FROM pet_latest_weight_v LIMIT 5;
SELECT * FROM pet_daily_feed_summary_v ORDER BY d_utc DESC LIMIT 5;
SELECT * FROM pet_health_timeline_v ORDER BY occurred_at DESC LIMIT 10;

```